{% load i18n %}
<div class="table-responsive">
  <table class="table align-middle">
    <thead>
      <tr>
        <th scope="col">{% translate 'Participant' %}</th>
        <th scope="col">{% translate 'Description' %}</th>
        <th scope="col" class="text-end">{% translate 'Montant demandé' %}</th>
        <th scope="col">{% translate 'Statut' %}</th>
        <th scope="col">{% translate 'Date' %}</th>
        <th scope="col" class="text-end">{% translate 'Actions' %}</th>
        <th scope="col" class="text-end">{% translate 'Admin' %}</th>
      </tr>
    </thead>
    <tbody>
      {% for p in participations %}
        <tr>
          <td>{{ p.participant.email }}</td>
          <td class="small">{{ p.description|linebreaksbr }}</td>
          <td class="text-end">{{ p.requested_amount_eur|floatformat:2 }} {{ initiative.asset.currency_code }}</td>
          <td>
            {% if p.state == 'requested' %}
              <span class="badge text-bg-warning">{% translate 'Demande formulée' %}</span>
            {% elif p.state == 'approved_admin' %}
              <span class="badge text-bg-info">{% translate 'Demande validée : GO !' %}</span>
            {% elif p.state == 'completed_user' %}
              <span class="badge text-bg-secondary">{% translate 'Action terminée' %}</span>
            {% elif p.state == 'validated_admin' %}
              <span class="badge text-bg-success">{% translate 'Action validée' %}</span>
            {% else %}
              {{ p.state }}
            {% endif %}
          </td>
          <td>{{ p.created_at|date:'Y-m-d H:i' }}</td>
          <td class="text-end">
            {% if user.is_authenticated and p.participant_id == user.id %}
              {% if p.state == 'requested' or p.state == 'approved_admin' %}
                <button class="btn btn-sm btn-outline-primary"
                        title="{% translate 'Indiquer comme terminée' %}"
                        onclick="crowdsMarkParticipationCompleted('{{ p.uuid }}')">
                  {% translate 'Marquer terminé' %}
                </button>
              {% elif p.state == 'completed_user' or p.state == 'validated_admin' %}
                {% if p.time_spent_minutes %}
                  <span class="text-muted small">{{ p.time_spent_minutes }} {% translate 'min' %}</span>
                {% endif %}
              {% endif %}
            {% else %}
              {% if p.state == 'completed_user' or p.state == 'validated_admin' %}
                {% if p.time_spent_minutes %}
                  <span class="text-muted small">{{ p.time_spent_minutes }} {% translate 'min' %}</span>
                {% endif %}
              {% endif %}
            {% endif %}
          </td>
          <td class="text-end">
            {% if user.is_authenticated %}
              {% if user.is_staff or user.is_superuser %}
                {% if p.state == 'requested' %}
                  <button class="btn btn-sm btn-outline-success"
                          title="{% translate 'Valider la demande' %}"
                          hx-post="{{ initiative.get_absolute_url }}participations/{{ p.uuid }}/approve/"
                          hx-target="#participations_list"
                          hx-swap="innerHTML">
                    {% translate 'Approuver' %}
                  </button>
                {% elif p.state == 'completed_user' %}
                  <button class="btn btn-sm btn-outline-success"
                          title="{% translate 'Valider la participation' %}"
                          hx-post="{{ initiative.get_absolute_url }}participations/{{ p.uuid }}/validate/"
                          hx-target="#participations_list"
                          hx-swap="innerHTML">
                    {% translate 'Valider' %}
                  </button>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted py-4">{% translate 'Aucune participation pour le moment.' %}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
