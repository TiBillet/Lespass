{% extends base_template %}
{% load i18n tibitags %}

{% block title %}{{ initiative.name }}{% endblock %}
{% block meta_description %}{% if initiative.short_description %}{{ initiative.short_description|striptags }}
    {% elif initiative.description %}{{ initiative.description|safe|striptags|truncatechars:150 }}{% else %}
    {{ initiative.name }}{% endif %} - {{ config.organisation }}{% endblock %}
{% block og_title %}{{ initiative.name }}{% endblock %}
{% block og_description %}{% if initiative.short_description %}{{ initiative.short_description|striptags }}
    {% elif initiative.description %}{{ initiative.description|safe|striptags|truncatechars:150 }}{% else %}
    {{ initiative.name }}{% endif %} - {{ config.organisation }}{% endblock %}
{% block og_image %}{% with image=initiative.get_img %}{% if image and image.social_card %}{{ image.social_card.url }}
{% elif image and image.hdr %}{{ image.hdr.url }}{% else %}{{ block.super }}{% endif %}{% endwith %}{% endblock %}
{% block og_image_alt %}{{ initiative.name }} - {{ config.organisation }}{% endblock %}
{% block twitter_title %}{{ initiative.name }}{% endblock %}
{% block twitter_description %}{% if initiative.short_description %}{{ initiative.short_description|striptags }}
    {% elif initiative.description %}{{ initiative.description|safe|striptags|truncatechars:150 }}{% else %}
    {{ initiative.name }}{% endif %} - {{ config.organisation }}{% endblock %}
{% block twitter_image %}{% with image=initiative.get_img %}{% if image and image.social_card %}
    {{ image.social_card.url }}{% elif image and image.hdr %}{{ image.hdr.url }}{% else %}{{ block.super }}{% endif %}
{% endwith %}{% endblock %}
{% block twitter_image_alt %}{{ initiative.name }} - {{ config.organisation }}{% endblock %}

{% block main %}
    <main class="container-lg pb-5">
        <header class="mb-3">
            {% include 'reunion/partials/picture.html' with img=initiative.get_img alt=initiative.name style='max-height: 33vh' %}
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mt-3">
                <h1 class="mb-0">{{ initiative.name }}
                    {% if initiative.closed %}
                        <span class="badge bg-secondary ms-2" data-testid="badge-closed-detail">
                            <i class="bi bi-lock"></i> {% translate "Cl√¥tur√©" %}
                        </span>
                    {% endif %}
                    {% if initiative.vote %}
                        {# compteur de votes #}
                        <span class="ms-sm-2">
                        {% include 'crowds/partial/votes_badge.html' with initiative=initiative %}
                    </span>
                    {% endif %}
                </h1>

                {# Admin buttons #}
                {% if user.is_staff or user.is_superuser %}
                    <div class="d-flex gap-2 flex-shrink-0" data-testid="admin-actions">
                        {% if not initiative.closed %}
                            <form method="post" action="{{ initiative.get_absolute_url }}close/" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning btn-sm" data-testid="btn-close">
                                    <i class="bi bi-lock"></i> {% translate "Cl√¥turer" %}
                                </button>
                            </form>
                        {% endif %}
                        {% if not initiative.archived %}
                            <form method="post" action="{{ initiative.get_absolute_url }}archive/" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm" data-testid="btn-archive"
                                        onclick="return confirm('{% translate "√ätes-vous s√ªr de vouloir archiver cette initiative ?" %}');">
                                    <i class="bi bi-archive"></i> {% translate "Archiver" %}
                                </button>
                            </form>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            {# Tags de l‚Äôinitiative #}
            {% if initiative.tags.all %}
                <p class="mt-2" aria-label="Tags de l‚Äôinitiative">
                    {% for tag in initiative.tags.all %}
                        <a class="badge rounded-pill text-decoration-none me-1 mb-1"
                           style="{{ tag.style_attr }}"
                           href="{% url 'crowds-list' %}?tag={{ tag.slug }}"
                           hx-get="{% url 'crowds-list' %}?tag={{ tag.slug }}"
                           hx-target="body"
                           hx-swap="innerHTML"
                           hx-push-url="true">
                            <i class="bi bi-tag" aria-hidden="true"></i> {{ tag.name }}
                        </a>
                    {% endfor %}
                </p>
            {% endif %}

        </header>

        <p class="lead">{{ initiative.description |safe |default:"" }}</p>

        {# 1) Votes #}
        {% if initiative.vote %}
            <section id="votes" class="mt-5 p-3 p-sm-4 rounded-3 bg-body-tertiary shadow-sm">
                <h2 class="h4 mb-3 d-flex align-items-center justify-content-between">
                    <span>{% translate 'Votes' %}</span>
                    {% if not initiative.closed %}
                        <span>
                        {% if user.is_authenticated %}
                            <button
                                    class="btn btn-sm btn-primary"
                                    title="{% translate 'Voter pour la pertinence' %}"
                                    hx-post="{{ initiative.get_absolute_url }}vote/"
                                    hx-trigger="click"
                                    hx-target="#votes-{{ initiative.uuid }}"
                                    hx-swap="outerHTML">
                                üëç {% translate 'Voter' %}
                            </button>
                        {% else %}
                            <button
                                    class="btn btn-sm btn-primary"
                                    title="{% translate 'Voter pour la pertinence' %}"
                                    onclick="crowdsVoteRequireLogin()">
                                üëç {% translate 'Voter' %}
                            </button>
                        {% endif %}
                    </span>
                    {% endif %}
                </h2>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                        <tr>
                            <th scope="col">{% translate 'Votant¬∑e' %}</th>
                            {% if show_votes_origin %}
                                <th scope="col">{% translate 'Origine' %}</th>
                            {% endif %}
                            <th scope="col">{% translate 'Date' %}</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% with total=votes|length %}
                            {% for v in votes %}
                                {% if forloop.counter == 5 %}
                                    </tbody>
                                    <tbody id="votes-more-{{ initiative.uuid }}" class="collapse">
                                {% endif %}
                                <tr>
                                    <td>{{ v.user.full_name_or_email_trunc }}</td>
                                    {% if show_votes_origin %}
                                        <td>{{ v.user.client_source.name|default:"‚Äî" }}</td>
                                    {% endif %}
                                    <td>{{ v.created_at|date:'d/m/y' }}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="{% if show_votes_origin %}3{% else %}2{% endif %}"
                                        class="text-center text-muted py-4">{% translate 'Aucun vote pour le moment.' %}</td>
                                </tr>
                            {% endfor %}
                        {% endwith %}
                        </tbody>
                    </table>
                </div>
                {% with total=votes|length %}
                    {% if total > 4 %}
                        <div class="text-center mt-2">
                            <button class="btn btn-sm btn-outline-secondary" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#votes-more-{{ initiative.uuid }}"
                                    aria-expanded="false" aria-controls="votes-more-{{ initiative.uuid }}"
                                    onclick="this.dataset.altText=this.dataset.altText||this.innerText; const t=this.getAttribute('aria-expanded')==='true'?this.dataset.altText:'{% translate 'Afficher moins' %}'; this.innerText=t;">
                                {% translate 'Afficher plus' %}
                            </button>
                        </div>
                    {% endif %}
                {% endwith %}
            </section>
        {% endif %}

        {# 2) Lignes budg√©taires #}
        <section id="budget" class="mt-4 p-3 p-sm-4 rounded-3 bg-body-secondary shadow-sm">
            <h2 class="h4 mb-3 d-flex align-items-center justify-content-between">
                <span>{% translate 'Lignes budg√©taires' %}</span>
                {% if not initiative.closed %}
                    <span>
                        <button class="btn btn-sm btn-primary"
                                onclick="return (window.crowdsOpenBudgetItemProposal ? crowdsOpenBudgetItemProposal() : (window.crowdsShowBudgetProposalFallback ? crowdsShowBudgetProposalFallback() : alert('Module non charge')))">
                            üí° {% translate 'Proposer' %}
                        </button>
                    </span>
                {% endif %}
            </h2>
            <p class="text-muted small mb-2">
                {% translate 'Total √† financer' %}:
                <strong>{{ initiative.total_funding_amount|dround }} {{ initiative.currency }}</strong>
            </p>
            <div id="budget_items_list">
                {% include 'crowds/partial/budget_items.html' %}
            </div>
        </section>

        {# 3) Financement #}
        <section id="financement" class="my-4 p-3 p-sm-4 rounded-3 bg-body-tertiary shadow-sm">
            <h2 class="h4 mb-3 d-flex align-items-center justify-content-between">
                <span>{% translate 'Financement' %} {{ initiative.progress_percent_int }}%</span>
                {% if not initiative.closed %}
                    <span>
                        {% if user.is_authenticated %}
                            <button type="button" class="btn btn-sm btn-primary" title="{% translate 'Financer' %}"
                                    onclick="openContributionModal()">
                                üí∏ {% translate 'Financer' %}
                            </button>
                        {% else %}
                            <button type="button" class="btn btn-sm btn-primary" title="{% translate 'Financer' %}"
                                    onclick="crowdsVoteRequireLogin()">
                                üí∏ {% translate 'Financer' %}
                            </button>
                        {% endif %}
                    </span>
                {% endif %}
            </h2>
            <div class="progress">
                <div class="progress-bar bg-{{ initiative.progress_percent_color }}" role="progressbar" aria-valuemin="0"
                     aria-valuemax="100" aria-valuenow="{{ initiative.progress_percent_int }}" style="width: 0%"
                     data-requested-bar="1" data-width-int="{{ initiative.progress_percent_int }}">
                    <span class="visually-hidden">{{ initiative.requested_percent_int }}%</span>
                </div>
            </div>
            <p class="mt-2 mb-3 text-center text-muted small">
                {% translate "Financ√©" %}:
                <strong>{{ initiative.total_funded_amount|dround }} / {{ initiative.total_funding_amount|dround }} </strong>{{ initiative.currency }}
            </p>

            <div id="contributions_list">
                {% include 'crowds/partial/contributions.html' %}
            </div>
        </section>


        <script>
            (function () {
                // Remplit toutes les barres ayant data-requested-bar (financement + r√©alisations)
                function applyRequestedBars() {
                    try {
                        document.querySelectorAll('[data-requested-bar]')?.forEach(function (el) {
                            var v = parseInt(el.getAttribute('data-width-int') || '0', 10);
                            if (isNaN(v) || v < 0) v = 0;
                            if (v > 100) v = 100;
                            el.style.width = v + '%';
                        });
                    } catch (e) { /* noop */
                    }
                }

                // Appel imm√©diat si le DOM est d√©j√† pr√™t, sinon √† DOMContentLoaded
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', applyRequestedBars, {once: true});
                } else {
                    applyRequestedBars();
                }
                // Apr√®s les remplacements HTMX sur la page (ex: rafra√Æchissement de listes)
                document.body.addEventListener('htmx:afterSwap', applyRequestedBars);
                document.body.addEventListener('htmx:afterSettle', applyRequestedBars);
                // Expose pour debug √©ventuel
                window.crowdsApplyRequestedBars = applyRequestedBars;
            })();
        </script>

        {% if initiative.budget_contributif %}
            {# 4) R√©alisation #}
            <section id="realisation" class="mt-5 p-3 p-sm-4 rounded-3 bg-body-secondary shadow-sm">
                <h2 class="h4 mb-3 d-flex align-items-center justify-content-between">
                    <span>{% translate 'R√©alisation' %} : {{ initiative.requested_vs_funded_percent_int }}%</span>
                    {% if not initiative.closed %}
                        <span>
                            {% if user.is_authenticated %}
                                <button class="btn btn-sm btn-primary" onclick="crowdsOpenParticipate()">
                                    üõ†Ô∏è {% translate 'Participer' %}
                                </button>
                            {% else %}
                                <button class="btn btn-sm btn-primary" onclick="crowdsVoteRequireLogin()">
                                    üõ†Ô∏è {% translate 'Participer' %}
                                </button>
                            {% endif %}
                        </span>
                    {% endif %}
                </h2>
                {# Barre de progression des demandes de participations vs financements #}
                <div class="progress" style="height: .5rem;">
                    <div class="progress-bar bg-{{ initiative.requested_vs_funded_color }}" role="progressbar" aria-valuemin="0"
                         aria-valuemax="100" aria-valuenow="{{ initiative.requested_vs_funded_percent_int }}" style="width: 0%"
                         data-requested-bar="1" data-width-int="{{ initiative.requested_vs_funded_percent_int }}">
                        <span class="visually-hidden">{{ initiative.requested_vs_funded_percent_int }}%</span>
                    </div>
                </div>
                <p class="mt-2 mb-3 text-center text-muted small">
                    {% translate "Demand√© par les contributeur¬∑ices" %}:
                    <strong>{{ initiative.total_participation_amount|dround }} / {{ initiative.total_funded_amount|dround }} </strong>{{ initiative.currency }}
                </p>
                <h6 class="h6 mb-3">Pour en savoir plus sur les budgets contributifs, <a
                        href="https://movilab.org/wiki/Coremuneration_et_budget_contributif" target="_blank">visitez
                    movilab !</a></h6>
                <div id="participations_list">
                    {% include 'crowds/partial/participations.html' %}
                </div>
            </section>
        {% endif %}

        <section id="retour">
            <div class="d-grid gap-2 d-sm-flex justify-content-sm-start align-items-center my-4">
                <a href="{% url 'crowds-list' %}"
                   class="btn btn-outline-secondary"
                   hx-get="{% url 'crowds-list' %}"
                   hx-target="body"
                   hx-swap="innerHTML"
                   hx-push-url="true">
                    ‚Üê {% translate 'Retour' %}
                </a>
            </div>

        </section>

        {# Helpers JS pour actions de la page d√©tail #}
        {% translate "Proposer une ligne budg√©taire" as t_bi_title %}
        {% translate "Le module n'est pas encore charg√©. R√©essayez ou rechargez la page." as t_bi_not_loaded %}
        {% translate "D√©crivez la d√©pense propos√©e" as t_bi_desc %}
        {% blocktrans with cur=initiative.currency asvar t_bi_amount_prompt %}Montant propos√© (en {{ cur }}){% endblocktrans %}
        {% translate "Proposition envoy√©e" as t_bi_sent %}
        {% translate "Impossible d'envoyer" as t_bi_send_fail %}
        {% translate "Erreur r√©seau" as t_bi_net_err %}
        {% blocktrans with cur=initiative.currency asvar t_bi_amount_label %}Montant (en {{ cur }}){% endblocktrans %}
        {% translate "Description" as t_bi_desc_label %}
        {% translate "Envoyer" as t_bi_send %}
        {% translate "Annuler" as t_bi_cancel %}
        {% translate "Veuillez indiquer un montant valide." as t_bi_amount_invalid %}
        {% translate "Veuillez d√©crire en quelques mots (min 5 caract√®res)." as t_bi_desc_invalid %}
        {% translate "Une erreur est survenue." as t_bi_error %}
        {% translate "J'accepte les r√®gles de contribution" as t_part_covenant %}
        {% translate "Veuillez accepter les r√®gles de contribution." as t_part_covenant_required %}
        {% blocktrans with cur=initiative.currency asvar t_part_amount_label %}Montant estim√© (en {{ cur }}){% endblocktrans %}
        {% translate "Vous pourrez le changer lors de votre validation, ou le mettre √† zero." as t_part_amount_help %}
        {% translate "Veuillez saisir un montant avec au maximum deux d√©cimales." as t_part_amount_decimals %}
        <script>
            (function () {
                const isAuth = {{ user.is_authenticated|yesno:"true,false" }};
                // Safely expose i18n strings for JS (already escaped for JS context)
                const T = Object.freeze({
                    bi_title: '{{ t_bi_title|escapejs }}',
                    not_loaded: '{{ t_bi_not_loaded|escapejs }}',
                    bi_desc: '{{ t_bi_desc|escapejs }}',
                    bi_amount_prompt: '{{ t_bi_amount_prompt|escapejs }}',
                    sent: '{{ t_bi_sent|escapejs }}',
                    send_fail: '{{ t_bi_send_fail|escapejs }}',
                    net_err: '{{ t_bi_net_err|escapejs }}',
                    amount_label: '{{ t_bi_amount_label|escapejs }}',
                    desc_label: '{{ t_bi_desc_label|escapejs }}',
                    send: '{{ t_bi_send|escapejs }}',
                    cancel: '{{ t_bi_cancel|escapejs }}',
                    amount_invalid: '{{ t_bi_amount_invalid|escapejs }}',
                    desc_invalid: '{{ t_bi_desc_invalid|escapejs }}',
                    error_generic: '{{ t_bi_error|escapejs }}',
                    part_covenant: '{{ t_part_covenant|escapejs }}',
                    part_covenant_required: '{{ t_part_covenant_required|escapejs }}',
                    part_amount_label: '{{ t_part_amount_label|escapejs }}',
                    part_amount_help: '{{ t_part_amount_help|escapejs }}',
                    part_amount_decimals: '{{ t_part_amount_decimals|escapejs }}',
                    pro_bono_name: '{{ crowd_config.pro_bono_name|default:"Pro-bono"|escapejs }}',
                });
                const partCovenantUrl = '{{ crowd_config.contributor_covenant|default:"https://movilab.org/wiki/Coremuneration_et_budget_contributif"|escapejs }}';
                window.CROWDS_I18N = T;
                window.CROWDS_CONFIG = Object.freeze({
                    partCovenantUrl: partCovenantUrl,
                    proBonoName: T.pro_bono_name || 'Pro-bono',
                });
                window.T = T;

                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                    return null;
                }

                // Fallback used by the inline onclick if the main function isn't loaded
                window.crowdsShowBudgetProposalFallback = function () {
                    try {
                        if (window.Swal && typeof Swal.fire === 'function') {
                            Swal.fire({icon: 'info', title: T.bi_title, text: T.not_loaded});
                        } else {
                            alert(T.not_loaded);
                        }
                    } catch (e) { /* noop */
                    }
                };

                window.crowdsOpenBudgetItemProposal = function () {
                    try {
                        if (!isAuth) {
                            if (typeof window.crowdsVoteRequireLogin === 'function') {
                                return window.crowdsVoteRequireLogin();
                            }
                        }
                        if (!(window.Swal && typeof window.Swal.fire === 'function')) {
                            const desc = prompt(T.bi_desc);
                            if (!desc) return;
                            const amount = prompt(T.bi_amount_prompt);
                            if (!amount) return;
                            const formData = new URLSearchParams();
                            formData.set('description', desc);
                            formData.set('amount_eur', amount);
                            fetch("{{ initiative.get_absolute_url }}budget/propose/", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                                    'X-CSRFToken': getCookie('csrftoken') || ''
                                },
                                body: formData.toString()
                            }).then(async (r) => {
                                if (r.status === 401) {
                                    window.crowdsVoteRequireLogin && crowdsVoteRequireLogin();
                                    return;
                                }
                                const data = await r.json().catch(() => ({}));
                                if (r.ok && data && data.html) {
                                    const target = document.getElementById('budget_items_list');
                                    if (target) target.innerHTML = data.html;
                                    if (window.Swal) Swal.fire({
                                        toast: true,
                                        position: 'top',
                                        timer: 1600,
                                        showConfirmButton: false,
                                        icon: 'success',
                                        title: T.sent
                                    });
                                } else {
                                    if (window.Swal) Swal.fire({
                                        icon: 'error',
                                        title: T.send_fail,
                                        text: (data && data.error) ? data.error : ''
                                    });
                                }
                            }).catch(() => {
                                if (window.Swal) Swal.fire({icon: 'error', title: T.net_err});
                            });
                            return;
                        }

                        Swal.fire({
                            title: T.bi_title,
                            html:
                                '<div class="mb-2 text-start">' +
                                '<label class="form-label">' + T.amount_label + '</label>' +
                                '<input id="swal_amount" type="number" step="0.01" min="0.01" class="form-control" placeholder="0.00" />' +
                                '</div>' +
                                '<div class="mb-2 text-start">' +
                                '<label class="form-label">' + T.desc_label + '</label>' +
                                '<textarea id="swal_desc" class="form-control" rows="3" placeholder="' + T.bi_desc + '"></textarea>' +
                                '</div>',
                            showCancelButton: true,
                            confirmButtonText: T.send,
                            cancelButtonText: T.cancel,
                            preConfirm: () => {
                                const amount = document.getElementById('swal_amount').value.trim();
                                const desc = document.getElementById('swal_desc').value.trim();
                                if (!amount || parseFloat(amount) <= 0) {
                                    Swal.showValidationMessage(T.amount_invalid);
                                    return false;
                                }
                                if (!desc || desc.length < 5) {
                                    Swal.showValidationMessage(T.desc_invalid);
                                    return false;
                                }
                                return {amount, desc};
                            }
                        }).then((res) => {
                            if (!res.isConfirmed) return;
                            if (!isAuth) {
                                window.crowdsVoteRequireLogin && crowdsVoteRequireLogin();
                                return;
                            }
                            const {amount, desc} = res.value || {};
                            const formData = new URLSearchParams();
                            formData.set('description', desc);
                            formData.set('amount_eur', amount);
                            fetch("{{ initiative.get_absolute_url }}budget/propose/", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                                    'X-CSRFToken': getCookie('csrftoken') || ''
                                },
                                body: formData.toString()
                            }).then(async (r) => {
                                if (r.status === 401) {
                                    window.crowdsVoteRequireLogin && crowdsVoteRequireLogin();
                                    return;
                                }
                                const data = await r.json().catch(() => ({}));
                                if (r.ok && data && data.html) {
                                    const target = document.getElementById('budget_items_list');
                                    if (target) target.innerHTML = data.html;
                                    Swal.fire({
                                        toast: true,
                                        position: 'top',
                                        timer: 1600,
                                        showConfirmButton: false,
                                        icon: 'success',
                                        title: T.sent
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: T.send_fail,
                                        text: (data && data.error) ? data.error : ''
                                    });
                                }
                            }).catch(() => {
                                Swal.fire({icon: 'error', title: T.net_err});
                            });
                        });
                    } catch (e) {
                        alert(T.error_generic);
                    }
                }
            })();
        </script>


        <script>
            function crowdsConfirmMarkContributionPaid(cid) {
                Swal.fire({
                    title: '{% translate "Confirmer le paiement" %}',
                    text: '{% translate "Marquer cette contribution comme pay√©e ?" %}',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '{% translate "Oui, marquer pay√©e" %}',
                    cancelButtonText: '{% translate "Annuler" %}'
                }).then((result) => {
                    if (result.isConfirmed) {
                        htmx.ajax('POST', `{{ initiative.get_absolute_url }}contributions/${cid}/mark-paid/`, {
                            target: '#contributions_list',
                            swap: 'innerHTML'
                        })
                    }
                })
            }

            function openContributionModal() {
                Swal.fire({
                    title: '{% translate "Contribuer financi√®rement" %}',
                    html: `
                        <div class="mb-3 text-start">
                            <label for="contrib-name" class="form-label">{% translate "Nom du contributeur ou de l'organisation" %}</label>
                            <input id="contrib-name" type="text" class="form-control" placeholder="{% translate "Votre nom" %}">
                            <div class="form-text">{{ contrib_name_help }}</div>
                        </div>
                        <div class="mb-3 text-start">
                            <label for="contrib-desc" class="form-label">{% translate "Message / description" %}</label>
                            <textarea id="contrib-desc" class="form-control" rows="3" placeholder="{% translate "Un mot pour l'√©quipe (optionnel)" %}"></textarea>
                            <div class="form-text">{{ contrib_desc_help }}</div>
                        </div>
                        <div class="mb-0 text-start">
                            <label for="contrib-amt" class="form-label">{% blocktrans with cur=initiative.currency %}
                        Montant (en {{ cur }}){% endblocktrans %}</label>
                            <input id="contrib-amt" type="number" min="0" step="0.01" class="form-control" placeholder="0.00">
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    cancelButtonText: '{% translate "Annuler" %}',
                    confirmButtonText: '{% translate "Valider la contribution" %}',
                    preConfirm: () => {
                        const name = document.getElementById('contrib-name').value.trim();
                        const desc = document.getElementById('contrib-desc').value.trim();
                        const amtStr = document.getElementById('contrib-amt').value.trim();
                        const amtNorm = amtStr.replace(',', '.');
                        const amtValid = /^\d+(\.\d{1,2})?$/.test(amtNorm);
                        const amt = Math.round(parseFloat(amtNorm || '0') * 100);
                        if (!name) {
                            Swal.showValidationMessage('{% translate "Veuillez indiquer votre nom." %}');
                            return false;
                        }
                        if (!amtValid) {
                            Swal.showValidationMessage('{% translate "Veuillez saisir un montant avec au maximum deux d√©cimales." %}');
                            return false;
                        }
                        if (!amt || amt <= 0) {
                            Swal.showValidationMessage('{% translate "Veuillez indiquer un montant valide (> 0)." %}');
                            return false;
                        }
                        htmx.ajax('POST', '{{ initiative.get_absolute_url }}contribute/', {
                            target: '#contributions_list',
                            swap: 'innerHTML',
                            values: {
                                contributor_name: name,
                                description: desc,
                                amount: amt
                            }
                        });
                    }
                });
            }

            // G√®re uniquement les r√©ponses JSON (paiement) et ignore le HTML (ex: vote badge)
            document.body.addEventListener('htmx:afterOnLoad', function (event) {
                try {
                    const xhr = event.detail.xhr;
                    const ctype = (xhr.getResponseHeader('Content-Type') || '').toLowerCase();
                    if (!ctype.includes('application/json')) {
                        return; // rien √† faire pour les r√©ponses HTML (partials HTMX)
                    }
                    const data = JSON.parse(xhr.responseText || 'null');
                    if (!data) return;
                    if (data.stripe_url) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Redirection vers le paiement...',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        setTimeout(() => window.location.href = data.stripe_url, 1200);
                    } else if (data.error) {
                        Swal.fire('Erreur', data.error, 'error');
                    }
                } catch (e) {
                    // ignore
                }
            });

            // --- Vote (detail page): only login helper, swap handled by HTMX returning HTML ---
            window.crowdsVoteRequireLogin = window.crowdsVoteRequireLogin || function () {
                Swal.fire({
                    icon: 'info',
                    title: '{% translate "Connexion requise" %}',
                    text: '{% translate "Veuillez vous connecter pour continuer." %}',
                    showCancelButton: true,
                    confirmButtonText: '{% translate "Se connecter" %}',
                    cancelButtonText: '{% translate "Annuler" %}'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const panel = document.getElementById('loginPanel');
                        if (panel) {
                            const offcanvas = new bootstrap.Offcanvas(panel);
                            offcanvas.show();
                        } else {
                            window.location.href = '/accounts/login/';
                        }
                    }
                });
            };

            // Feedback visuel apr√®s vote via HX-Trigger
            document.body.addEventListener('crowds:vote', function (e) {
                const created = !!(e && e.detail && e.detail.created);
                Swal.fire({
                    toast: true,
                    position: 'top',
                    timer: 1600,
                    showConfirmButton: false,
                    icon: created ? 'success' : 'info',
                    title: created ? '{% translate "Merci pour votre vote !" %}' : '{% translate "Votre vote est d√©j√† pris en compte." %}'
                });
            });

            // --- Participations: dialog + POST via HTMX to update partial ---
            window.crowdsOpenParticipate = function () {
                const I18N = window.CROWDS_I18N || {};
                const CROWDS = window.CROWDS_CONFIG || {};
                Swal.fire({
                    title: '{% translate "Proposer une participation" %}',
                    html: `
                        <div class="mb-3 text-start">
                            <label class="form-label">{% translate "Description de la participation" %}</label>
                            <textarea id="part-desc" class="form-control" rows="4" placeholder="{% translate "D√©crivez votre apport, r√¥le, t√¢ches‚Ä¶" %}"></textarea>
                        </div>
                        <div class="mb-0 text-start">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="part-pro-bono" checked>
                                <label class="form-check-label" for="part-pro-bono">${CROWDS.proBonoName || I18N.pro_bono_name || 'Pro-bono'}</label>
                            </div>
                            <div id="part-amt-wrap">
                                <label class="form-label">${I18N.part_amount_label || ''}</label>
                                <input id="part-amt" type="number" min="0" step="0.01" class="form-control" placeholder="0.00">
                                <div class="form-text">${I18N.part_amount_help || ''}</div>
                            </div>
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="part-covenant">
                                <label class="form-check-label" for="part-covenant">
                                    ${I18N.part_covenant || ''} <a href="${CROWDS.partCovenantUrl || 'https://movilab.org/wiki/Coremuneration_et_budget_contributif'}" target="_blank" rel="noopener noreferrer">{% translate "R√®gles de contribution" %}</a>
                                </label>
                            </div>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    cancelButtonText: '{% translate "Annuler" %}',
                    confirmButtonText: '{% translate "Envoyer la demande" %}',
                    didOpen: () => {
                        const proBono = document.getElementById('part-pro-bono');
                        const amtWrap = document.getElementById('part-amt-wrap');
                        if (proBono && amtWrap) {
                            const sync = () => {
                                amtWrap.style.display = proBono.checked ? 'none' : 'block';
                            };
                            proBono.addEventListener('change', sync);
                            sync();
                        }
                    },
                    preConfirm: () => {
                        const desc = document.getElementById('part-desc').value.trim();
                        const proBono = document.getElementById('part-pro-bono');
                        const amtStr = document.getElementById('part-amt')?.value.trim() || '';
                        const covenantOk = document.getElementById('part-covenant')?.checked;
                        if (!desc) {
                            Swal.showValidationMessage('{% translate "Veuillez d√©crire votre participation." %}');
                            return false;
                        }
                        if (!covenantOk) {
                            Swal.showValidationMessage(I18N.part_covenant_required || '');
                            return false;
                        }
                        if (!proBono?.checked) {
                            const amtNorm = amtStr.replace(',', '.');
                            const amtValid = amtNorm !== '' && /^\d+(\.\d{1,2})?$/.test(amtNorm);
                            if (!amtValid) {
                                Swal.showValidationMessage(I18N.part_amount_decimals || '');
                                return false;
                            }
                        }
                        // Post via HTMX and update the participations list without blink
                        const values = {description: desc};
                        if (!proBono?.checked && amtStr) {
                            const amtNorm = amtStr.replace(',', '.');
                            if (parseFloat(amtNorm) > 0) {
                                values.requested_amount = amtNorm;
                            }
                        }
                        htmx.ajax('POST', '{{ initiative.get_absolute_url }}participate/', {
                            target: '#participations_list',
                            swap: 'innerHTML',
                            values: values
                        });
                        Swal.close();
                        return true;
                    }
                });
            };

            window.crowdsMarkParticipationCompleted = function (pid) {
                Swal.fire({
                    title: '{% translate "Marquer la participation comme termin√©e" %}',
                    html: `
                        <div class="mb-0 text-start">
                            <label class="form-label">{% translate "Temps pass√©" %}</label>
                            <div class="input-group">
                                <input id="part-time-value" type="number" min="1" step="1" class="form-control" />
                                <select id="part-time-unit" class="form-select">
                                    <option value="minutes">{% translate "Minutes" %}</option>
                                    <option value="hours">{% translate "Heures" %}</option>
                                    <option value="days">{% translate "Jours (8h)" %}</option>
                                </select>
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    cancelButtonText: '{% translate "Annuler" %}',
                    confirmButtonText: '{% translate "Valider" %}',
                    preConfirm: (value) => {
                        const rawValue = document.getElementById('part-time-value')?.value || '';
                        const unit = document.getElementById('part-time-unit')?.value || 'minutes';
                        const base = parseInt(rawValue, 10);
                        const multipliers = {minutes: 1, hours: 60, days: 8 * 60};
                        const minutes = (multipliers[unit] || 1) * base;
                        if (!minutes || minutes <= 0) {
                            Swal.showValidationMessage('{% translate "Veuillez saisir une dur√©e valide (> 0)." %}');
                            return false;
                        }
                        htmx.ajax('POST', `{{ initiative.get_absolute_url }}participations/${pid}/complete/`, {
                            target: '#participations_list',
                            swap: 'innerHTML',
                            values: {time_spent_minutes: minutes}
                        });
                    }
                });
            };

        </script>

    </main>


{% endblock %}
