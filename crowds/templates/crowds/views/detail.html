{% extends base_template %}
{% load i18n %}

{% block title %}{{ initiative.name }}{% endblock %}
{% block meta_description %}{% if initiative.short_description %}{{ initiative.short_description|striptags }}{% elif initiative.description %}{{ initiative.description|safe|striptags|truncatechars:150 }}{% else %}{{ initiative.name }}{% endif %} - {{ config.organisation }}{% endblock %}
{% block og_title %}{{ initiative.name }}{% endblock %}
{% block og_description %}{% if initiative.short_description %}{{ initiative.short_description|striptags }}{% elif initiative.description %}{{ initiative.description|safe|striptags|truncatechars:150 }}{% else %}{{ initiative.name }}{% endif %} - {{ config.organisation }}{% endblock %}
{% block og_image %}{% with image=initiative.get_img %}{% if image and image.social_card %}{{ image.social_card.url }}{% elif image and image.hdr %}{{ image.hdr.url }}{% else %}{{ block.super }}{% endif %}{% endwith %}{% endblock %}
{% block og_image_alt %}{{ initiative.name }} - {{ config.organisation }}{% endblock %}
{% block twitter_title %}{{ initiative.name }}{% endblock %}
{% block twitter_description %}{% if initiative.short_description %}{{ initiative.short_description|striptags }}{% elif initiative.description %}{{ initiative.description|safe|striptags|truncatechars:150 }}{% else %}{{ initiative.name }}{% endif %} - {{ config.organisation }}{% endblock %}
{% block twitter_image %}{% with image=initiative.get_img %}{% if image and image.social_card %}{{ image.social_card.url }}{% elif image and image.hdr %}{{ image.hdr.url }}{% else %}{{ block.super }}{% endif %}{% endwith %}{% endblock %}
{% block twitter_image_alt %}{{ initiative.name }} - {{ config.organisation }}{% endblock %}

{% block main %}
    <main class="container-lg pb-5">
        <header class="mb-3">
            {% include 'reunion/partials/picture.html' with img=initiative.get_img alt=initiative.name style='max-height: 33vh' %}
            <h1 class="mt-3">{{ initiative.name }}
                {# compteur de votes #}
                <span class="ms-sm-2">
                    {% include 'crowds/partial/votes_badge.html' with initiative=initiative %}
                </span>
            </h1>

            {# Tags de l‚Äôinitiative #}
            {% if initiative.tags.all %}
                <p class="mt-2" aria-label="Tags de l‚Äôinitiative">
                    {% for tag in initiative.tags.all %}
                        <a class="badge rounded-pill text-decoration-none me-1 mb-1"
                           style="{{ tag.style_attr }}"
                           href="{% url 'crowds-list' %}?tag={{ tag.slug }}"
                           hx-get="{% url 'crowds-list' %}?tag={{ tag.slug }}"
                           hx-target="body"
                           hx-swap="innerHTML"
                           hx-push-url="true">
                            <i class="bi bi-tag" aria-hidden="true"></i> {{ tag.name }}
                        </a>
                    {% endfor %}
                </p>
            {% endif %}

        </header>

        <p class="lead">{{ initiative.description |safe |default:"" }}</p>

        <section class="my-4">
            <progress value="{{ initiative.progress_percent_int }}" max="100" class="w-100"
                      style="height: 1rem;"></progress>
            <p class="mt-2 mb-0 text-center">
                <strong>{{ funded_eur|floatformat:2 }} ‚Ç¨</strong> / {{ goal_eur|floatformat:2 }} ‚Ç¨
            </p>
        </section>

        {# Barre de progression des demandes de participations vs financements #}
        <section class="my-4">
            <div class="progress">
                <div class="progress-bar bg-{{ requested_color }}" role="progressbar" aria-valuemin="0"
                     aria-valuemax="100" aria-valuenow="{{ requested_percent_int_capped }}" style="width: 0%"
                     data-requested-bar="1" data-width-int="{{ requested_percent_int_capped }}">
                    <span class="visually-hidden">{{ requested_percent_int }}%</span>
                </div>
            </div>
            <p class="mt-2 mb-0 text-center text-muted small">
                {% translate "Demand√© par les contributeur.ices" %}:
                <strong>{{ requested_eur|floatformat:2 }} ‚Ç¨</strong>
                ‚Äî {% translate "financ√©" %}: <strong>{{ funded_eur|floatformat:2 }} ‚Ç¨</strong>
                ‚Äî {{ requested_percent_int }}%
            </p>
            <script>
                (function () {
                    try {
                        document.querySelectorAll('[data-requested-bar]')?.forEach(function (el) {
                            var v = parseInt(el.getAttribute('data-width-int') || '0', 10);
                            if (isNaN(v) || v < 0) v = 0;
                            if (v > 100) v = 100;
                            el.style.width = v + '%';
                        });
                    } catch (e) { /* noop */
                    }
                })();
            </script>
        </section>

        <div class="d-grid gap-2 d-sm-flex justify-content-sm-start align-items-center my-4">
            <a href="{% url 'crowds-list' %}"
               class="btn btn-outline-secondary"
               hx-get="{% url 'crowds-list' %}"
               hx-target="body"
               hx-swap="innerHTML"
               hx-push-url="true">
                ‚Üê {% translate 'Retour' %}
            </a>

            {# Bouton voter #}
            {% if user.is_authenticated %}
                <button
                        class="btn btn-primary"
                        title="{% translate 'Voter pour la pertinence' %}"
                        hx-post="{{ initiative.get_absolute_url }}vote/"
                        hx-trigger="click"
                        hx-target="#votes-{{ initiative.uuid }}"
                        hx-swap="outerHTML">
                    <i class="bi bi-hand-thumbs-up"></i>
                    {% translate 'Voter' %}
                </button>
            {% else %}
                <button
                        class="btn btn-primary"
                        title="{% translate 'Voter pour la pertinence' %}"
                        onclick="crowdsVoteRequireLogin()">
                    <i class="bi bi-hand-thumbs-up"></i>
                    {% translate 'Voter' %}
                </button>
            {% endif %}

            {# Participer (d√©claration de participation) #}
            {% if user.is_authenticated %}
                <button class="btn btn-outline-primary" onclick="crowdsOpenParticipate()">
                    <i class="bi bi-person-gear"></i>
                    {% translate 'Participer' %}
                </button>
            {% else %}
                <button class="btn btn-outline-primary" onclick="crowdsVoteRequireLogin()">
                    <i class="bi bi-person-gear"></i>
                    {% translate 'Participer' %}
                </button>
            {% endif %}

            {# Contribution financi√®re (formulaire Swal ‚Üí HTMX) #}
            {% if user.is_authenticated %}
                <button type="button" class="btn btn-primary" title="{% translate 'Contribuer financi√®rement' %}"
                        onclick="openContributionModal()">
                    üí∏ {% translate 'Contribuer financi√®rement' %}
                </button>
            {% else %}
                <button type="button" class="btn btn-primary" title="{% translate 'Contribuer financi√®rement' %}"
                        onclick="crowdsVoteRequireLogin()">
                    üí∏ {% translate 'Contribuer financi√®rement' %}
                </button>
            {% endif %}
        </div>


        <section class="mt-5">
            <h2 class="h4 mb-3">{% translate 'Votants' %}</h2>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                    <tr>
                        <th scope="col">{% translate 'Utilisateur' %}</th>
                        <th scope="col">{% translate 'Date' %}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for v in votes %}
                        <tr>
                            <td>{{ v.user.email }}</td>
                            <td>{{ v.created_at|date:'Y-m-d H:i' }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="2"
                                class="text-center text-muted py-4">{% translate 'Aucun vote pour le moment.' %}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="mt-5">
            <h2 class="h4 mb-3">{% translate 'Contributions financi√®res' %}</h2>
            <div id="contributions_list">
                {% include 'crowds/partial/contributions.html' %}
            </div>
        </section>


        <section class="mt-5">
            <h2 class="h4 mb-3">{% translate 'Participations' %}</h2>
            <div id="participations_list">
                {% include 'crowds/partial/participations.html' %}
            </div>
        </section>


        <script>
            function crowdsConfirmMarkContributionPaid(cid) {
                Swal.fire({
                    title: '{% translate "Confirmer le paiement" %}',
                    text: '{% translate "Marquer cette contribution comme pay√©e ?" %}',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: '{% translate "Oui, marquer pay√©e" %}',
                    cancelButtonText: '{% translate "Annuler" %}'
                }).then((result) => {
                    if (result.isConfirmed) {
                        htmx.ajax('POST', `{{ initiative.get_absolute_url }}contributions/${cid}/mark-paid/`, {
                            target: '#contributions_list',
                            swap: 'outerHTML'
                        })
                    }
                })
            }

            function openContributionModal() {
                Swal.fire({
                    title: '{% translate "Contribuer financi√®rement" %}',
                    html: `
                        <div class="mb-3 text-start">
                            <label for="contrib-name" class="form-label">{% translate "Nom du contributeur ou de l'organisation" %}</label>
                            <input id="contrib-name" type="text" class="form-control" placeholder="{% translate "Votre nom" %}">
                            <div class="form-text">{{ contrib_name_help }}</div>
                        </div>
                        <div class="mb-3 text-start">
                            <label for="contrib-desc" class="form-label">{% translate "Message / description" %}</label>
                            <textarea id="contrib-desc" class="form-control" rows="3" placeholder="{% translate "Un mot pour l'√©quipe (optionnel)" %}"></textarea>
                            <div class="form-text">{{ contrib_desc_help }}</div>
                        </div>
                        <div class="mb-0 text-start">
                            <label for="contrib-amt" class="form-label">{% translate "Montant (en euros)" %}</label>
                            <input id="contrib-amt" type="number" min="0" step="0.01" class="form-control" placeholder="0.00">
                            <div class="form-text">{% translate "Le montant sera converti en centimes." %}</div>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    cancelButtonText: '{% translate "Annuler" %}',
                    confirmButtonText: '{% translate "Valider la contribution" %}',
                    preConfirm: () => {
                        const name = document.getElementById('contrib-name').value.trim();
                        const desc = document.getElementById('contrib-desc').value.trim();
                        const amtStr = document.getElementById('contrib-amt').value;
                        const amt = Math.round(parseFloat(amtStr || '0') * 100);
                        if (!name) {
                            Swal.showValidationMessage('{% translate "Veuillez indiquer votre nom." %}');
                            return false;
                        }
                        if (!amt || amt <= 0) {
                            Swal.showValidationMessage('{% translate "Veuillez indiquer un montant valide (> 0)." %}');
                            return false;
                        }
                        htmx.ajax('POST', '{{ initiative.get_absolute_url }}contribute/', {
                            target: '#contributions_list',
                            swap: 'outerHTML',
                            values: {
                                contributor_name: name,
                                description: desc,
                                amount: amt
                            }
                        });
                    }
                });
            }

            // G√®re uniquement les r√©ponses JSON (paiement) et ignore le HTML (ex: vote badge)
            document.body.addEventListener('htmx:afterOnLoad', function (event) {
                try {
                    const xhr = event.detail.xhr;
                    const ctype = (xhr.getResponseHeader('Content-Type') || '').toLowerCase();
                    if (!ctype.includes('application/json')) {
                        return; // rien √† faire pour les r√©ponses HTML (partials HTMX)
                    }
                    const data = JSON.parse(xhr.responseText || 'null');
                    if (!data) return;
                    if (data.stripe_url) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Redirection vers le paiement...',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        setTimeout(() => window.location.href = data.stripe_url, 1200);
                    } else if (data.error) {
                        Swal.fire('Erreur', data.error, 'error');
                    }
                } catch (e) {
                    // ignore
                }
            });

            // --- Vote (detail page): only login helper, swap handled by HTMX returning HTML ---
            window.crowdsVoteRequireLogin = window.crowdsVoteRequireLogin || function () {
                Swal.fire({
                    icon: 'info',
                    title: '{% translate "Connexion requise" %}',
                    text: '{% translate "Veuillez vous connecter pour continuer." %}',
                    showCancelButton: true,
                    confirmButtonText: '{% translate "Se connecter" %}',
                    cancelButtonText: '{% translate "Annuler" %}'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const panel = document.getElementById('loginPanel');
                        if (panel) {
                            const offcanvas = new bootstrap.Offcanvas(panel);
                            offcanvas.show();
                        } else {
                            window.location.href = '/accounts/login/';
                        }
                    }
                });
            };

            // Feedback visuel apr√®s vote via HX-Trigger
            document.body.addEventListener('crowds:vote', function (e) {
                const created = !!(e && e.detail && e.detail.created);
                Swal.fire({
                    toast: true,
                    position: 'top',
                    timer: 1600,
                    showConfirmButton: false,
                    icon: created ? 'success' : 'info',
                    title: created ? '{% translate "Merci pour votre vote !" %}' : '{% translate "Votre vote est d√©j√† pris en compte." %}'
                });
            });

            // --- Participations: dialog + POST via HTMX to update partial ---
            window.crowdsOpenParticipate = function () {
                Swal.fire({
                    title: '{% translate "Proposer une participation" %}',
                    html: `
                        <div class="mb-3 text-start">
                            <label class="form-label">{% translate "Description de la participation" %}</label>
                            <textarea id="part-desc" class="form-control" rows="4" placeholder="{% translate "D√©crivez votre apport, r√¥le, t√¢ches‚Ä¶" %}"></textarea>
                        </div>
                        <div class="mb-0 text-start">
                            <label class="form-label">{% translate "Montant sollicit√© (en euros)" %}</label>
                            <input id="part-amt" type="number" min="0" step="0.01" class="form-control" placeholder="0.00">
                            <div class="form-text">{% translate "Ce montant correspond √† votre part du budget estim√©." %}</div>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    cancelButtonText: '{% translate "Annuler" %}',
                    confirmButtonText: '{% translate "Envoyer la demande" %}',
                    preConfirm: () => {
                        const desc = document.getElementById('part-desc').value.trim();
                        const amtStr = document.getElementById('part-amt').value;
                        const amt = Math.round(parseFloat(amtStr || '0') * 100);
                        if (!desc) {
                            Swal.showValidationMessage('{% translate "Veuillez d√©crire votre participation." %}');
                            return false;
                        }
                        if (!amt || amt <= 0) {
                            Swal.showValidationMessage('{% translate "Veuillez indiquer un montant valide (> 0)." %}');
                            return false;
                        }
                        // Post via HTMX and update the participations list without blink
                        htmx.ajax('POST', '{{ initiative.get_absolute_url }}participate/', {
                            target: '#participations_list',
                            swap: 'outerHTML',
                            values: {
                                description: desc,
                                requested_amount_cents: amt
                            }
                        });
                    }
                });
            };

            window.crowdsMarkParticipationCompleted = function (pid) {
                Swal.fire({
                    title: '{% translate "Marquer la participation comme termin√©e" %}',
                    input: 'number',
                    inputLabel: '{% translate "Temps pass√© (en minutes)" %}',
                    inputAttributes: {min: 1, step: 1},
                    showCancelButton: true,
                    cancelButtonText: '{% translate "Annuler" %}',
                    confirmButtonText: '{% translate "Valider" %}',
                    preConfirm: (value) => {
                        const minutes = parseInt(value || '0');
                        if (!minutes || minutes <= 0) {
                            Swal.showValidationMessage('{% translate "Veuillez saisir une dur√©e valide (> 0)." %}');
                            return false;
                        }
                        htmx.ajax('POST', `{{ initiative.get_absolute_url }}participations/${pid}/complete/`, {
                            target: '#participations_list',
                            swap: 'outerHTML',
                            values: {time_spent_minutes: minutes}
                        });
                    }
                });
            };

            // Attach once per page load
            document.body.addEventListener('htmx:afterRequest', window.crowdsHandleVote);
        </script>

    </main>


{% endblock %}
