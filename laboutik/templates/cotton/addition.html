{% load static i18n %}

<div id="addition">
	<div class="addition-legend-grid">
		<div></div>
		<div>{% translate "QTE" %}</div>
		<div>{% translate "PRODUIT" %}</div>
		<div>{% translate "PRIX" %}</div>
	</div>
	<div id="addition-list"></div>
	<!-- Attention aucun input dans #addition-form ne doit contenir "repid-" dans son attribut name 
	 le formulaire est rempli automatiquement par article.js -->
	<form id="addition-form" class="hide" hx-post="hx_display_type_payment" hx-trigger="validerPaiement"
		hx-target="#messages" hx-swap="outerHTML" hx-include='[class="addition-include-data"]'
		hx-on::after-request="hideAndEmptyElement('#confirm')"></form>
	<!-- hx-include -->
	<input class="addition-include-data" name="id_table" value="{{ id_table }}" />
	<input class="addition-include-data" name="uuid_pv" value="{{ pv.id }}" />
	<input class="addition-include-data" name="responsable" value="{{ card.name }}" />
	<input class="addition-include-data" name="tag_id_cm" value="{{ card.tag_id }}" />
	<input class="addition-include-data" id="addition-comportement" name="comportement" value="{{ pv.comportement }}" />
	<input class="addition-include-data" id="addition-total" name="total" value="" />
	<input class="addition-include-data" id="addition-moyen-paiement" name="moyen_paiement" value="" />
	<input class="addition-include-data" id="addition-hostname-client" name="hostname_client" value="" />

</div>

<script>
	function paiementIsPossible(event) {
		let nbArticles = 0
		// compte le nombre d'articles dans l'addition
		event.target.querySelectorAll('input').forEach(ele => {
			const name = ele.getAttribute('name')
			if (name.includes('repid-')) {
				nbArticles++
			}
		})

		if (nbArticles <= 0) {
			// affiche message pas d'articles
			document.querySelector('#message-no-article').classList.remove('hide')
		} else {
			// préparation post type de paiement
			event.target.setAttribute('hx-post', 'hx_display_type_payment')
			event.target.setAttribute('hx-trigger', 'validerPaiement')
			htmx.process(event.target)

			// valide l'envoie du paiement
			sendEvent('validerPaiement', '#addition-form')
		}
	}

	document.querySelector('#addition-form').addEventListener('paymentIsPossible?', paiementIsPossible)

	document.addEventListener('DOMContentLoaded', () => {
		// récupère le hostname du local storage
		let hosname = ''
		try {
			hosname = JSON.parse(localStorage.getItem('laboutik')).hostname
		} catch (error) {
			console.log('Récupération du hostname:', error);
		}
		document.querySelector('#addition-hostname-client').value = hosname
	})
</script>

<style>
	#addition {
		display: none;
		flex-direction: column;
		width: 100%;
		height: 100%;
		color: var(--blanc01);
	}

	#addition-list {
		width: 100%;
		/* dev */
		/* height: calc(var(--addition-list-heigh) - var(--addition-legend-heigh)); */
		height: calc(100% - var(--addition-legend-heigh));
		overflow-y: auto;
		scrollbar-width: none
	}

	.addition-legend-grid {
		width: 100%;
		height: 20px;
		display: grid;
		grid-template-columns: 12% 12% 60% 16%;
		font-size: 14px;
		font-weight: 600;
		color: var(--gris03);
		border-bottom: 1px solid var(--gris07);
	}

	.addition-line-grid {
		width: 100%;
		min-height: var(--addition-line-heigh);
		display: grid;
		grid-template-columns: 12% 12% 60% 16%;
		color: var(--blanc01);
		font-size: 16px;
		font-weight: 400;
		margin: 8px 0;
	}

	.addition-col-bt {
		font-size: 1.8rem;
		/* background-color: aqua; */
	}

	.addition-col-number,
	.addition-col-name,
	.addition-col-prix {
		overflow: hidden;
	}

	#addition-form {
		display: none;
		/* width: 100%;
		height: 30%;
		overflow-y: auto;
		scrollbar-width: none; */
	}

	.addition-include-data {
		display: none;
	}

	/* pour une largeur supérieure 1022 pixels */
	@media only screen and (width > 1022px) {
		#addition {
			display: flex;
			flex-direction: column;
			width: 29%;
			background-color: var(--gris10);
		}
	}
</style>