{% load i18n tibitags static %}

<style>
    form summary::marker {
        content: "";
    }
</style>


<form id="reservation_form" hx-post="reservation/" class="d-flex flex-column justify-content-between h-100">
    <div>
        <input type="hidden" name="event" value="{{ event.uuid }}">
        {% if user.is_anonymous %}
            <div class="mb-3">
                <label for="booking-email" class="form-label">{% trans "Email" %}</label>
                <input type="email" name="email" class="form-control" id="booking-email" required>
            </div>
            <div class="mb-3">
                <label for="booking-confirm" class="form-label">{% trans "Email confirmation" %}</label>
                <input type="email" name="email-confirm" class="form-control" id="booking-confirm" required>
            </div>

            <div id="email-error" class="invalid-feedback" role="heading" style="display: block"></div>
            <script>
                document.getElementById("reservation_form").addEventListener("htmx:configRequest", function (event) {
                    const email = document.getElementById("booking-email").value;
                    console.log(email);
                    const confirmEmail = document.getElementById("booking-confirm").value;
                    const errorDiv = document.getElementById("email-error");
                    console.log(confirmEmail);

                    if (email !== confirmEmail) {
                        event.preventDefault(); // empêche l’envoi de la requête HTMX
                        errorDiv.textContent = "Les emails ne correspondent pas.";
                    } else {
                        errorDiv.textContent = ""; // nettoyage si c’est bon
                    }
                });
            </script>
            {#            <p><code>{{ user.email }}</code></p>#}
        {% elif user.is_active %}
            <div class="mb-3">
                <label for="booking-email" class="form-label">{% trans "Email" %}</label>
                <input type="email" class="form-control" id="booking-email" name="email" value="{{ user.email }}"
                       readonly>
            </div>
        {% else %}
            <div class="alert alert-danger" role="alert">
                {% translate "Your email is not confirmed. Please check your spam folder :)" %}
            </div>
        {% endif %}

        <div class="accordion mb-3">
            {% regroup event.published_prices by free_price as price_groups %}
            {% for free_price, published_prices in price_groups %}
                <details class="accordion-item js-price-group" name="price_groups"
                         {% if forloop.first %}open{% endif %}>
                    <summary class="text-secondary p-3">
                        {% if free_price %}
                            {% trans 'Open price (one ticket)' %}
                        {% else %}
                            {% trans 'Specific prices' %}
                        {% endif %}
                    </summary>
                    {% for price in published_prices %}
                        {% if price.free_price == free_price %}
                            <div class="p-3 js-order">
                                <label for="amount-{{ price.uuid }}" class="form-label">
                                    <strong>{{ price.name }}</strong>{% if not free_price and price.prix > 0 %}&nbsp;:
                                    <span class="js-order-price">{{ price.prix }}</span>&nbsp;€
                                {% elif free_price %}
                                    <span class="js-order-price-alt d-none">{% trans 'at an open price' %}</span>
                                {% endif %}
                                </label>
                                <!-- Adhésion obligatoire pour selectionner ce produit ! -->
                                {% if price.adhesion_obligatoire %}
                                    {% if not user.is_authenticated %}
                                        <div class="alert alert-danger" role="alert">
                                            {% trans "Log in to access this rate." %}
                                        </div>
                                    {% elif not user|is_membership:price.adhesion_obligatoire %}
                                        <div class="alert alert-danger" role="alert">
                                            {% trans "Suscribe to access this rate." %}
                                        </div>
                                    {% else %}
                                        <span class="d-flex align-items-baseline gap-3">
                            <bs-counter
                                    id="amount-{{ price.uuid }}"
                                    name="{{ price.uuid }}"
                                    step="1" min="0"
                                    max="




                                            {% if price.max_per_user > event.max_per_user %}{{ event.max_per_user }}{% else %}{{ price.max_per_user }}{% endif %}"
                                    class="flex-grow-1 js-order-amount"
                            ></bs-counter>
                            {% trans 'ticket(s)' %}
                        </span>
                                    {% endif %}
                                    <!-- Adhésion non obligatoire -->
                                {% else %}
                                    <span class="d-flex align-items-baseline gap-3">
                            <bs-counter
                                    id="amount-{{ price.uuid }}"
                                    name="{{ price.uuid }}"
                                    step="1" min="0"
                                    max="




                                            {% if price.max_per_user > event.max_per_user %}{{ event.max_per_user }}{% else %}{{ price.max_per_user }}{% endif %}"
                                    class="flex-grow-1 js-order-amount"
                            ></bs-counter>
                            {% trans 'ticket(s)' %}
                        </span>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </details>
            {% endfor %}
        </div>
        {% for option in event.options_radio.all %}
            <div class="mb-3 has-validation">
                <div class="form-check me-3">
                    <input id="option-radio-{{ option.uuid }}" name="options"
                           class="form-check-input" type="radio" value="{{ option.uuid }}"
                           required>
                    <label class="custom-control-label" for="option-radio-{{ option.uuid }}">
                        {{ option.name }}
                    </label>
                </div>
            </div>
        {% endfor %}
        {% for option in event.options_checkbox.all %}
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="option-checkbox-{{ option.uuid }}"
                       name="options" value="{{ option.uuid }}">
                <label class="form-check-label" for="option-checkbox-{{ option.uuid }}">
                    {{ option.name }}
                </label>
            </div>
        {% endfor %}

        {# Dynamic product form fields (same method as membership form) #}
        {% with products=event.products.all %}
            {% for product in products %}
                {% with fields=product.form_fields.all %}
                    {% if fields %}
                        <hr>
                        {% if products|length > 1 %}
                            <h5 class="h6 mb-2">{{ product.name }}</h5>
                        {% endif %}
                        <h4 class="h5 mb-3">{% translate "Additional information" %}</h4>
                        {% for field in fields %}
                            {% if field.field_type == 'ST' %}
                                <div class="mb-3">
                                    <label class="form-label" for="ff-{{ field.uuid }}">{{ field.label }}</label>
                                    <input id="ff-{{ field.uuid }}" name="form__{{ field.name }}" type="text"
                                           class="form-control"
                                           placeholder="{{ field.placeholder|default:field.label }}"
                                           {% if field.required %}required{% endif %}>
                                    {% if field.help_text %}
                                        <div class="form-text">{{ field.help_text }}</div>
                                    {% endif %}
                                </div>
                            {% elif field.field_type == 'LT' %}
                                <div class="mb-3">
                                    <label class="form-label" for="ff-{{ field.uuid }}">{{ field.label }}</label>
                                    <textarea id="ff-{{ field.uuid }}" name="form__{{ field.name }}"
                                              class="form-control" style="height: 120px"
                                              placeholder="{{ field.placeholder|default:field.label }}"
                                              {% if field.required %}required{% endif %}></textarea>
                                    {% if field.help_text %}
                                        <div class="form-text">{{ field.help_text }}</div>
                                    {% endif %}
                                </div>
                            {% elif field.field_type == 'SS' %}
                                <div class="mb-3">
                                    <label class="form-label" for="ff-{{ field.uuid }}">{{ field.label }}</label>
                                    <select id="ff-{{ field.uuid }}" name="form__{{ field.name }}" class="form-select"
                                            {% if field.required %}required{% endif %}>
                                        <option value="" {% if field.required %}disabled selected{% endif %}>—</option>
                                        {% for opt in field.options %}
                                            <option value="{{ opt }}">{{ opt }}</option>
                                        {% endfor %}
                                    </select>
                                    {% if field.help_text %}
                                        <div class="form-text">{{ field.help_text }}</div>
                                    {% endif %}
                                </div>
                            {% elif field.field_type == 'MS' %}
                                <div class="mb-3">
                                    <div class="form-label">{{ field.label }}</div>
                                    {% for opt in field.options %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   id="ff-{{ field.uuid }}-{{ forloop.counter }}"
                                                   name="form__{{ field.name }}" value="{{ opt }}">
                                            <label class="form-check-label"
                                                   for="ff-{{ field.uuid }}-{{ forloop.counter }}">{{ opt }}</label>
                                        </div>
                                    {% endfor %}
                                    {% if field.help_text %}
                                        <div class="form-text">{{ field.help_text }}</div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            {% endfor %}
        {% endwith %}

        <h4>
            {% trans 'Total&nbsp;:' %} <span class="js-total-amount">0</span> {% trans 'ticket(s)' %}
            <span class="js-total-has-price">
                {% trans 'for' %}
                <span class="fs-5 badge bg-secondary-subtle mb-md-0"><span
                        class="js-total-price">1,00</span>&nbsp;€</span>
            </span>
        </h4>
        <p>
            {% trans "Maximum capacity of tickets limited to" %}<span
                class="js-max-amount"> {{ event.max_per_user }} </span>{% trans 'per buyer' %}.
        </p>
    </div>

    <div class="p-3">
        {# Promotional code input - show if any product has promotional codes #}
        {% if event.products.all %}
            {% for product in event.products.all %}
                {% if product.promotional_codes.exists %}
                    <div class="mb-3">
                        <label for="promotional-code" class="form-label">{% trans "Promotional code" %}</label>
                        <input type="text" name="promotional_code" class="form-control" id="promotional-code"
                               placeholder="{% trans 'Enter your promotional code' %}">
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}


        <button type="submit" class="btn btn-primary w-100 mb-3">{% trans 'Send booking request' %}</button>
        <a href="." class="btn btn-danger d-block">{% trans 'Cancel' %}</a>
    </div>
</form>

<script type="module">
    import * as BookingCalculator from '{% static "reunion/js/booking-calculator.mjs" %}'
    import * as Spinner from '{% static "reunion/js/form-spinner.mjs" %}'

    // show spinner on form submission
    const form = document.getElementById('reservation_form')
    Spinner.init(form)
    BookingCalculator.init()

    // Prevent HTMX request if no quantity selected (> 0 required)
    form.addEventListener('htmx:configRequest', (event) => {
        try {
            const totalEl = document.querySelector('.js-total-amount')
            const total = parseInt((totalEl?.textContent || '0').replace(/\D+/g, ''), 10) || 0
            if (total <= 0) {
                event.preventDefault()
                // Show a simple inline error (Bootstrap alert if available)
                let err = document.getElementById('booking-form-error')
                if (!err) {
                    err = document.createElement('div')
                    err.id = 'booking-form-error'
                    err.className = 'alert alert-danger mt-2'
                    // Insert the error right above the submit buttons
                    const footer = form.querySelector('.p-3')
                    ;(footer?.parentElement || form).insertBefore(err, footer || null)
                }
                err.textContent = "Veuillez sélectionner au moins 1 billet avant d'envoyer la demande."
                // Also scroll into view for visibility
                err.scrollIntoView({behavior: 'smooth', block: 'center'})
            }
        } catch (e) {
            // Fail open: if any unexpected error occurs, do not block the request
        }
    })
</script>
