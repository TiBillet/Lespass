{% extends base_template %}

{% load static tibitags i18n %}

{% block title %}{% translate 'Generate QR Code' %}{% endblock %}

{% block main %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                {% if qrcode_generated %}
                    <!-- Display generated QR code -->
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h3 class="text-center">Paiement</h3>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-success mb-4">
                                <h5 class="mb-3">ðŸ’³ Paiement simple</h5>
                                <p class="mb-2">Montant: <strong class="fs-4">{{ amount | dround }}</strong> â€” Devise: <strong class="fs-5">{{ asset_type }}</strong></p>
                                <hr>
                                <p class="mb-2">Il y a 3 faÃ§ons de rÃ©aliser la transaction :</p>
                                <ul class="mb-3 ps-3">
                                    <li class="mb-1">ðŸ“· Faire scanner le QR code ciâ€‘dessous.</li>
                                    <li class="mb-1">ðŸ”— Copier le lien de paiement et lâ€™envoyer par message.</li>
                                    <li class="mb-1">ðŸªª Lire une carte TiBillet (Chrome ou Opera sous Android).</li>
                                </ul>
                                <div class="d-grid gap-2">
                                    <button id="copy-pay-link-btn" type="button" class="btn btn-outline-success btn-lg fw-bold" aria-label="Copier le lien de paiement" data-link="{{ qrcode_content }}">
                                        ðŸ”— Copier le lien de paiement
                                    </button>
                                    <small class="text-muted">Astuce: collez ensuite dans SMS, WhatsApp, Signal, etc.</small>
                                    <button id="nfc-scan-btn" type="button" class="btn btn-outline-primary btn-lg fw-bold" aria-label="Lire la carte TiBillet (NFC)">
                                        ðŸªª Lire la carte TiBillet (NFC)
                                    </button>
                                </div>
                            </div>
                            

                            <!-- QR Code Display -->
                            <div class="d-flex justify-content-center align-items-center mb-4" style="min-height: 300px; width: 100%;">
                                <div class="qr-code-container" style="width: 75%; min-width: 200px; max-width: 400px; overflow: hidden; padding: 10px; border-radius: 8px; background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); box-sizing: border-box;">
                                    <style>
                                        .qr-code-container svg {
                                            width: 100%;
                                            height: auto;
                                            display: block;
                                            margin: 0 auto;
                                            max-height: 100%;
                                            object-fit: contain;
                                            aspect-ratio: 1/1;
                                            background-color: #ffffff; /* keep white even if parent goes dark */
                                            filter: none !important; /* avoid dark-mode inversion */
                                        }

                                        /* Ensure the QR container stays white in all themes */
                                        .qr-code-container {
                                            background-color: #ffffff !important;
                                            filter: none !important;
                                        }
                                        
                                        /* Responsive adjustments */
                                        @media (max-width: 576px) {
                                            .qr-code-container {
                                                width: 90% !important;
                                                min-width: 150px !important;
                                                padding: 8px;
                                            }
                                        }
                                        
                                        @media (min-width: 992px) {
                                            .qr-code-container {
                                                max-width: 450px !important;
                                            }
                                        }

                                        /* Dark mode reinforcement */
                                        @media (prefers-color-scheme: dark) {
                                            .qr-code-container,
                                            .qr-code-container svg {
                                                background-color: #ffffff !important;
                                                filter: none !important;
                                            }
                                        }
                                    </style>
                                    <div id="qrcode-js" class="d-flex justify-content-center"></div>
                                    <script src="{% static 'reunion/js/qrcode.min.js' %}"></script>
                                    <script>
                                    (function(){
                                      const content = "{{ qrcode_content }}";
                                      const container = document.querySelector('.qr-code-container');
                                      const holder = document.getElementById('qrcode-js');
                                      if(!container || !holder || !content){ return; }
                                      function sizePx(){
                                        const w = container.clientWidth || 256;
                                        const s = Math.max(128, Math.min(512, Math.floor(w - 20)));
                                        return s;
                                      }
                                      let currentSize = 0;
                                      let qri = null;
                                      function render(){
                                        const s = sizePx();
                                        if(Math.abs(s - currentSize) < 16 && qri){ return; }
                                        currentSize = s;
                                        holder.innerHTML = "";
                                        qri = new QRCode(holder, {
                                          text: content,
                                          width: s,
                                          height: s,
                                          colorDark : "#000000",
                                          colorLight : "#ffffff",
                                          correctLevel : QRCode.CorrectLevel.H
                                        });
                                      }
                                      render();
                                      let to=null;
                                      window.addEventListener('resize', function(){
                                        clearTimeout(to);
                                        to=setTimeout(render, 150);
                                      });
                                    })();
                                    </script>
                                </div>
                            </div>

                            <!-- SweetAlert2 and NFC logic -->
                            <script src="{% static 'mvt_htmx/js/sweetalert2@11.js' %}"></script>
                            <script>
                            (function(){
                              const btn = document.getElementById('nfc-scan-btn');
                              if(!btn) return;
                              const supported = 'NDEFReader' in window;
                              if(!supported){
                                btn.disabled = true;
                                btn.textContent = 'NFC : fonctionne sur Android avec Chrome ou OpÃ©ra uniquement.';
                                return;
                              }
                              function getCookie(name){
                                const value = `; ${document.cookie}`;
                                const parts = value.split(`; ${name}=`);
                                if(parts.length === 2) return parts.pop().split(';').shift();
                              }
                              btn.addEventListener('click', async ()=>{
                                try{
                                  const ndef = new NDEFReader();
                                  ndef.addEventListener('reading', async (event)=>{
                                    try{
                                      const records = [];
                                      const dec = new TextDecoder();
                                      for(const rec of (event.message && event.message.records) || []){
                                        let dataText = '';
                                        try{
                                          if(rec.data){ dataText = dec.decode(rec.data); }
                                        }catch(_){/* ignore */}
                                        records.push({
                                          recordType: rec.recordType,
                                          mediaType: rec.mediaType || null,
                                          id: rec.id || null,
                                          data: dataText
                                        });
                                      }
                                      const payload = {
                                        tagSerial: event.serialNumber || null,
                                        records: records,
                                        ligne_article_uuid_hex: '{{ ligne_article_uuid_hex|default:"" }}'
                                      };
                                      const res = await fetch("{% url 'qrcodescanpay-process-with-nfc' %}", {
                                        method: 'POST',
                                        headers: {
                                          'Content-Type': 'application/json',
                                          'X-CSRFToken': getCookie('csrftoken') || ''
                                        },
                                        body: JSON.stringify(payload),
                                        credentials: 'same-origin'
                                      });
                                      let out = {};
                                      try{ out = await res.json(); }catch(e){}
                                      function firstErrorMessage(o){
                                        if(!o) return null;
                                        if(o.detail) return o.detail;
                                        if(o.error) return o.error;
                                        if(o.message) return o.message;
                                        if(Array.isArray(o.non_field_errors) && o.non_field_errors.length){ return o.non_field_errors[0]; }
                                        const keys = Object.keys(o || {});
                                        for(const k of keys){
                                          const v = o[k];
                                          if(Array.isArray(v) && v.length){ return v[0]; }
                                          if(typeof v === 'string' && v){ return v; }
                                        }
                                        return null;
                                      }
                                      if(!res.ok){
                                        const msg = firstErrorMessage(out) || 'Une erreur est survenue : ' + res.status + ' ' + res.statusText + '';
                                        Swal.fire('Erreur', msg, 'error');
                                      }else{
                                        const nf = (v)=>{
                                          const n = typeof v === 'string' ? parseFloat(v) : (typeof v === 'number' ? v : NaN);
                                          if(!isNaN(n)) return new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(n);
                                          return v;
                                        };
                                        const statusTxt = out.status || 'Paiement OK';
                                        const email = out.user_email || out.email || null;
                                        const amount = nf(out.amount_paid);
                                        const balance = nf(out.balance);
                                        const tagShown = out.tag_id || out.tagSerial || payload.tagSerial || null;
                                        const details = [
                                          (amount !== undefined && amount !== null) ? 'Montant payÃ©: ' + amount : null,
                                          email ? 'Compte: ' + email : null,
                                          (balance !== undefined && balance !== null) ? '<br>Solde restant: ' + balance : null,
                                        ].filter(Boolean).join('<br>');
                                        const redirectUrl = "{% url 'qrcodescanpay-get-generator' %}";
                                        Swal.fire({
                                          icon: 'success',
                                          title: statusTxt,
                                          html: details || 'OpÃ©ration rÃ©alisÃ©e avec succÃ¨s.',
                                          confirmButtonText: 'OK'
                                        }).then((result)=>{
                                          if(result && result.isConfirmed){
                                            window.location.href = redirectUrl;
                                          }
                                        });
                                      }
                                    }catch(e){
                                      Swal.fire('Erreur', 'Lecture NFC Ã©chouÃ©e: ' + (e && e.message ? e.message : e), 'error');
                                    }
                                  }, { once: true });
                                  Swal.fire({
                                    title: 'Lecteur NFC',
                                    html: 'attente de lecteur de carte TiBillet',
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    didOpen: () => { Swal.showLoading(); }
                                  });
                                  await ndef.scan();
                                }catch(err){
                                  Swal.fire('Erreur', 'Impossible de dÃ©marrer la lecture NFC: ' + (err && err.message ? err.message : err), 'error');
                                  return;
                                }
                              });
                            })();
                            </script>

                            <script>
                            (function(){
                              function copyText(text){
                                if(navigator.clipboard && navigator.clipboard.writeText){
                                  return navigator.clipboard.writeText(text);
                                }
                                return new Promise(function(resolve, reject){
                                  try{
                                    const ta = document.createElement('textarea');
                                    ta.value = text;
                                    ta.style.position = 'fixed';
                                    ta.style.left = '-9999px';
                                    document.body.appendChild(ta);
                                    ta.focus();
                                    ta.select();
                                    const ok = document.execCommand('copy');
                                    document.body.removeChild(ta);
                                    ok ? resolve() : reject(new Error('copy failed'));
                                  }catch(e){ reject(e); }
                                });
                              }
                              document.addEventListener('click', function(ev){
                                const btn = ev.target.closest('#copy-pay-link-btn');
                                if(!btn) return;
                                const link = btn.getAttribute('data-link');
                                if(!link) return;
                                copyText(link)
                                  .then(()=>{
                                    if(window.Swal){
                                      Swal.fire({icon:'success', title:'Lien copiÃ©', text:'Le lien de paiement est dans le presseâ€‘papier.', timer:1500, showConfirmButton:false});
                                    }else{
                                      alert('Lien copiÃ© dans le presseâ€‘papier');
                                    }
                                  })
                                  .catch((err)=>{
                                    if(window.Swal){
                                      Swal.fire({icon:'error', title:'Erreur', text:'Impossible de copier le lien: ' + (err && err.message ? err.message : err)});
                                    }else{
                                      alert('Impossible de copier le lien');
                                    }
                                  });
                              });
                            })();
                            </script>

                            <!-- Payment status check button using HTMX -->
                            <div class="my-3" id="check-payment-button" role="status" aria-live="polite">
                                <div class="d-grid">
                                    <button type="button"
                                            class="btn btn-warning btn-lg py-3 fw-bold w-100 text-dark"
                                            hx-target="#check-payment-button"
                                            hx-get="{% url 'qrcodescanpay-check-payment' pk=ligne_article_uuid_hex %}"
                                            hx-swap="outerHTML"
                                            aria-label="VÃ©rifier le statut du paiement">
                                        VÃ©rifier le paiement
                                    </button>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <a href="{% url 'qrcodescanpay-get-generator' %}"
                                   class="btn btn-primary btn-lg py-3 w-100 fw-bold text-white"
                                   aria-label="{% translate 'Generate Another QR Code' %}">
                                    {% translate 'Generate Another QR Code' %}
                                </a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- QR Code Generator Form -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h3 class="text-center">Initier un paiement</h3>
                        </div>
                        <div class="card-body">
                            <p class="lead text-center mb-4">
                                Remplissez les informations ci-dessous pour initier un paiement.
                            </p>
                            
                            <form method="post" action="{% url 'qrcodescanpay-generate-qrcode' %}">
                                {% csrf_token %}
                                
                                <div class="mb-4">
                                    <label for="amount" class="form-label">{% translate 'Amount' %}</label>
                                    <div class="input-group">
                                        <input type="number" 
                                               class="form-control form-control-lg" 
                                               id="amount" 
                                               name="amount" 
                                               min="0.01" 
                                               step="0.01" 
                                               placeholder="0.00" 
                                               required>
                                        <span class="input-group-text">â‚¬</span>
                                    </div>
                                    <div class="form-text">{% translate 'Enter the payment amount' %}</div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="asset_type" class="form-label">{% translate 'Asset Type' %}</label>
                                    <select class="form-select form-select-lg" id="asset_type" name="asset_type" required>
                                        <option value="EURO" selected>{% translate 'EURO' %}</option>
                                        <option value="CADEAU" disabled>{% translate 'CADEAU' %}</option>
                                        <option value="TEMPS" disabled>{% translate 'TEMPS' %}</option>
                                    </select>
                                    <div class="form-text">{% translate 'Select the type of asset for this payment' %}</div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="bi bi-qr-code me-2"></i>
                                        Initier un paiement
                                    </button>
                                    
                                    <a href="{% url 'my_account-list' %}" class="btn btn-outline-secondary">
                                        {% translate 'Cancel' %}
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}