{% extends base_template %}

{% load static tibitags i18n %}

{% block title %}{% translate 'Generate QR Code' %}{% endblock %}

{% block main %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                {% if qrcode_generated %}
                    <!-- Display generated QR code -->
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h3 class="text-center">{% translate 'QR Code Generated' %}</h3>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-success mb-4">
                                <h5>{% translate 'Payment Details' %}:</h5>
                                <p><strong>{% translate 'Amount' %}:</strong> <span class="fs-4">{{ amount | dround }}</span></p>
                                <p><strong>{% translate 'Asset Type' %}:</strong> <span class="fs-4">{{ asset_type }}</span></p>
                                <p>{% translate 'Direct link' %}: <a href="{{ qrcode_content }}" target="_blank">{{ qrcode_content }}</a></p>
                            </div>
                            
                            <!-- NFC Scan Button -->
                            <div class="mb-3 d-grid">
                                <button id="nfc-scan-btn" type="button" class="btn btn-outline-primary btn-lg fw-bold">
                                    Lecture carte NFC TiBillet
                                </button>
                                <div id="nfc-compat-message" class="form-text mt-2 text-danger" style="display:none;">
                                    Lecteur NFC non disponible sur ce navigateur, utilisez Chrome sur Android.
                                </div>
                            </div>

                            <!-- QR Code Display -->
                            <div class="d-flex justify-content-center align-items-center mb-4" style="min-height: 300px; width: 100%;">
                                <div class="qr-code-container" style="width: 75%; min-width: 200px; max-width: 400px; overflow: hidden; padding: 10px; border-radius: 8px; background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); box-sizing: border-box;">
                                    <style>
                                        .qr-code-container svg {
                                            width: 100%;
                                            height: auto;
                                            display: block;
                                            margin: 0 auto;
                                            max-height: 100%;
                                            object-fit: contain;
                                            aspect-ratio: 1/1;
                                            background-color: #ffffff; /* keep white even if parent goes dark */
                                            filter: none !important; /* avoid dark-mode inversion */
                                        }

                                        /* Ensure the QR container stays white in all themes */
                                        .qr-code-container {
                                            background-color: #ffffff !important;
                                            filter: none !important;
                                        }
                                        
                                        /* Responsive adjustments */
                                        @media (max-width: 576px) {
                                            .qr-code-container {
                                                width: 90% !important;
                                                min-width: 150px !important;
                                                padding: 8px;
                                            }
                                        }
                                        
                                        @media (min-width: 992px) {
                                            .qr-code-container {
                                                max-width: 450px !important;
                                            }
                                        }

                                        /* Dark mode reinforcement */
                                        @media (prefers-color-scheme: dark) {
                                            .qr-code-container,
                                            .qr-code-container svg {
                                                background-color: #ffffff !important;
                                                filter: none !important;
                                            }
                                        }
                                    </style>
                                    {{ qrcode_svg|safe }}
                                </div>
                            </div>

                            <!-- SweetAlert2 and NFC logic -->
                            <script src="{% static 'mvt_htmx/js/sweetalert2@11.js' %}"></script>
                            <script>
                            (function(){
                              const btn = document.getElementById('nfc-scan-btn');
                              if(!btn) return;
                              const compatMsg = document.getElementById('nfc-compat-message');
                              const supported = 'NDEFReader' in window;
                              if(!supported){
                                btn.disabled = true;
                                btn.textContent = 'Lecteur NFC non disponible';
                                if(compatMsg){ compatMsg.style.display='block'; }
                                return;
                              }
                              function getCookie(name){
                                const value = `; ${document.cookie}`;
                                const parts = value.split(`; ${name}=`);
                                if(parts.length === 2) return parts.pop().split(';').shift();
                              }
                              btn.addEventListener('click', async ()=>{
                                try{
                                  const ndef = new NDEFReader();
                                  ndef.addEventListener('reading', async (event)=>{
                                    try{
                                      const records = [];
                                      const dec = new TextDecoder();
                                      for(const rec of (event.message && event.message.records) || []){
                                        let dataText = '';
                                        try{
                                          if(rec.data){ dataText = dec.decode(rec.data); }
                                        }catch(_){/* ignore */}
                                        records.push({
                                          recordType: rec.recordType,
                                          mediaType: rec.mediaType || null,
                                          id: rec.id || null,
                                          data: dataText
                                        });
                                      }
                                      const payload = {
                                        tagSerial: event.serialNumber || null,
                                        records: records,
                                        ligne_article_uuid_hex: '{{ ligne_article_uuid_hex|default:"" }}'
                                      };
                                      const res = await fetch("{% url 'qrcodescanpay-process-with-nfc' %}", {
                                        method: 'POST',
                                        headers: {
                                          'Content-Type': 'application/json',
                                          'X-CSRFToken': getCookie('csrftoken') || ''
                                        },
                                        body: JSON.stringify(payload),
                                        credentials: 'same-origin'
                                      });
                                      let out = {};
                                      try{ out = await res.json(); }catch(e){}
                                      Swal.fire('Lecture confirmée', 'Carte lue: ' + (out.tagSerial || payload.tagSerial || 'OK'), 'success');
                                    }catch(e){
                                      Swal.fire('Erreur', 'Lecture NFC échouée: ' + (e && e.message ? e.message : e), 'error');
                                    }
                                  }, { once: true });
                                  Swal.fire({
                                    title: 'Lecteur NFC',
                                    html: 'attente de lecteur de carte TiBillet',
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    didOpen: () => { Swal.showLoading(); }
                                  });
                                  await ndef.scan();
                                }catch(err){
                                  Swal.fire('Erreur', 'Impossible de démarrer la lecture NFC: ' + (err && err.message ? err.message : err), 'error');
                                  return;
                                }
                              });
                            })();
                            </script>

                            <!-- Payment status check button using HTMX -->
                            <div class="my-3" id="check-payment-button" role="status" aria-live="polite">
                                <div class="d-grid">
                                    <button type="button"
                                            class="btn btn-warning btn-lg py-3 fw-bold w-100 text-dark"
                                            hx-target="#check-payment-button"
                                            hx-get="{% url 'qrcodescanpay-check-payment' pk=ligne_article_uuid_hex %}"
                                            hx-swap="outerHTML"
                                            aria-label="Vérifier le statut du paiement">
                                        Vérifier le paiement
                                    </button>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <a href="{% url 'qrcodescanpay-get-generator' %}"
                                   class="btn btn-primary btn-lg py-3 w-100 fw-bold text-white"
                                   aria-label="{% translate 'Generate Another QR Code' %}">
                                    {% translate 'Generate Another QR Code' %}
                                </a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- QR Code Generator Form -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h3 class="text-center">{% translate 'Generate Payment QR Code' %}</h3>
                        </div>
                        <div class="card-body">
                            <p class="lead text-center mb-4">
                                {% translate 'Fill in the details below to generate a payment QR code' %}
                            </p>
                            
                            <form method="post" action="{% url 'qrcodescanpay-generate-qrcode' %}">
                                {% csrf_token %}
                                
                                <div class="mb-4">
                                    <label for="amount" class="form-label">{% translate 'Amount' %}</label>
                                    <div class="input-group">
                                        <input type="number" 
                                               class="form-control form-control-lg" 
                                               id="amount" 
                                               name="amount" 
                                               min="0.01" 
                                               step="0.01" 
                                               placeholder="0.00" 
                                               required>
                                        <span class="input-group-text">€</span>
                                    </div>
                                    <div class="form-text">{% translate 'Enter the payment amount' %}</div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="asset_type" class="form-label">{% translate 'Asset Type' %}</label>
                                    <select class="form-select form-select-lg" id="asset_type" name="asset_type" required>
                                        <option value="EURO" selected>{% translate 'EURO' %}</option>
                                        <option value="CADEAU" disabled>{% translate 'CADEAU' %}</option>
                                        <option value="TEMPS" disabled>{% translate 'TEMPS' %}</option>
                                    </select>
                                    <div class="form-text">{% translate 'Select the type of asset for this payment' %}</div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="bi bi-qr-code me-2"></i>
                                        {% translate 'Generate QR Code' %}
                                    </button>
                                    
                                    <a href="{% url 'my_account-list' %}" class="btn btn-outline-secondary">
                                        {% translate 'Cancel' %}
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}