{% load i18n static tibitags %}
<form id="membership-form" hx-post="/memberships/" hx-target="#target_formbricks"
      class="d-flex flex-column justify-content-between h-100">
    <div>

        <h3>{{ product.name }}</h3>
        <p>{{ product.short_description }}</p>
        {% if product.long_description %}
            <p>{{ product.long_description | safe }}</p>
        {% endif %}

        <div id="target_formbricks">
            <script type="module">
                import * as Spinner from '{% static "reunion/js/form-spinner.mjs" %}'

                // show spinner on form submission
                Spinner.init(document.getElementById('membership-form'))
            </script>
        </div>
        <input type="hidden" name="product" value="{{ product.uuid }}">

        <!-- prix -->
        <div class="mb-3 has-validation">
            {% for price in product.prices.all %}
                {% if price.publish %}
                    <div class="form-check me-3">
                        <input id="price-{{ price.uuid }}" class="form-check-input" type="radio" name="price"
                               value="{{ price.uuid }}" required>
                        <label class="custom-control-label" for="price-{{ price.uuid }}">
                            {% if price.free_price %}
                                {{ price.name }}
                            {% else %}
                                {{ price.name }} - {{ price.prix }}€
                            {% endif %}
                            {% if price.fedow_reward_enabled %}
                                <span>
                                    <em>{% trans " : This price will give you " %}{{ price.fedow_reward_amount | dround }}
                                    {{ price.fedow_reward_asset.name }} {% trans "credited to your TiBillet wallet !" %}</em>
                                </span>
                            {% endif %}
                        </label>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        {% if user.is_anonymous %}
            <div class="form-floating mb-3">
                <input id="membership-email" name="email" type="email" class="form-control"
                       placeholder="adresse@exemple.fr" role="textbox"
                       aria-label="{% trans 'Email address' %}" required>
                <label for="email">{% trans 'Email address' %}</label>
            </div>

            <div class="form-floating mb-3">
                <input id="confirm-email" name="confirm-email" type="email" class="form-control"
                       placeholder="adresse@exemple.fr"
                       role="textbox"
                       aria-label="{% trans 'Email confirmation' %}" required>
                <label for="confirm-email">{% trans 'Email confirmation' %}</label>
            </div>

            <div id="email-error" class="invalid-feedback" role="heading" style="display: block"></div>
            <script>
                document.getElementById("membership-form").addEventListener("htmx:configRequest", function (event) {
                    const email = document.getElementById("membership-email").value;
                    console.log(email);
                    const confirmEmail = document.getElementById("confirm-email").value;
                    const errorDiv = document.getElementById("email-error");
                    console.log(confirmEmail);

                    if (email !== confirmEmail) {
                        event.preventDefault(); // empêche l’envoi de la requête HTMX
                        errorDiv.textContent = "Les emails ne correspondent pas.";
                    } else {
                        errorDiv.textContent = ""; // nettoyage si c’est bon
                    }
                });
            </script>

        {% elif user.is_active %}
            <div class="form-floating mb-3">
                <input name="email" type="email" class="form-control" placeholder="adresse@exemple.fr" role="textbox"
                       aria-label="{% trans 'Email address' %}" value="{{ user.email }}" readonly>
                <label for="email">{% trans 'Email address' %}</label>
            </div>
        {% else %}
            <p>
                <code>{% translate "You have not confirmed your email address. Please check your inbox (and just in case, your spam folder!)." %}</code>
            </p>
        {% endif %}


        {% translate "First name" as default_first_label %}
        {% with first_label=config.first_input_label_membership|default:default_first_label %}
            <div class="form-floating mb-3">
                <input name="firstname" type="text" class="form-control" placeholder="{{ first_label }}"
                       role="textbox" value="{{ user.first_name|default:"" }}"
                       aria-label="{{ first_label }}" required>
                <label for="firstname">{{ first_label }}</label>
            </div>
        {% endwith %}

        {% translate "Last name or organization" as default_second_label %}
        {% with second_label=config.second_input_label_membership|default:default_second_label %}
            <div class="form-floating mb-3">
                <input name="lastname" type="text" class="form-control" placeholder="{{ second_label }}"
                       role="textbox" value="{{ user.last_name|default:"" }}"
                       aria-label="{{ second_label }}" required>
                <label for="lastname">{{ second_label }}</label>
            </div>
        {% endwith %}
        <!-- options radio -->
        <div class="mb-3 has-validation">
            {% for option in product.option_generale_radio.all %}
                <div class="form-check me-3">
                    <input class="form-check-input" type="radio"
                           name="options"
                           id="options-radio-{{ option.uuid }}"
                           value="{{ option.uuid }}">
                    <label class="custom-control-label text-darkms-0"
                           for="options-radio-{{ option.uuid }}">
                        {{ option.name }}
                    </label>
                </div>
            {% endfor %}
        </div>

        <!-- options checkbox -->
        {% for option in product.option_generale_checkbox.all %}
            <div class="form-check form-switch mb-3">
                <input name="options" class="form-check-input" type="checkbox" role="switch"
                       id="checkbox-{{ option.uuid }}" value="{{ option.uuid }}">
                <label class="form-check-label" for="checkbox-{{ option.uuid }}">
                    {{ option.name }}
                </label>
            </div>
        {% endfor %}

        <!-- dynamic product form fields -->
        {% with fields=product.form_fields.all %}
            {% if fields %}
                <hr>
                <h4 class="h5 mb-3">{% translate "Additional information" %}</h4>
                {% for field in fields %}
                    {% if field.field_type == 'ST' %}
                        <div class="form-floating mb-3">
                            <input id="ff-{{ field.uuid }}" name="form__{{ field.name }}" type="text" class="form-control"
                                   placeholder="{{ field.label }}" {% if field.required %}required{% endif %}>
                            <label for="ff-{{ field.uuid }}">{{ field.label }}</label>
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}
                        </div>
                    {% elif field.field_type == 'LT' %}
                        <div class="form-floating mb-3">
                            <textarea id="ff-{{ field.uuid }}" name="form__{{ field.name }}" class="form-control" style="height: 120px"
                                      placeholder="{{ field.label }}" {% if field.required %}required{% endif %}></textarea>
                            <label for="ff-{{ field.uuid }}">{{ field.label }}</label>
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}
                        </div>
                    {% elif field.field_type == 'SS' %}
                        <div class="mb-3">
                            <label class="form-label" for="ff-{{ field.uuid }}">{{ field.label }}</label>
                            <select id="ff-{{ field.uuid }}" name="form__{{ field.name }}" class="form-select" {% if field.required %}required{% endif %}>
                                <option value="" {% if field.required %}disabled selected{% endif %}>—</option>
                                {% for opt in field.options %}
                                    <option value="{{ opt }}">{{ opt }}</option>
                                {% endfor %}
                            </select>
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}
                        </div>
                    {% elif field.field_type == 'MS' %}
                        <div class="mb-3">
                            <div class="form-label">{{ field.label }}</div>
                            {% for opt in field.options %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="ff-{{ field.uuid }}-{{ forloop.counter }}"
                                           name="form__{{ field.name }}" value="{{ opt }}">
                                    <label class="form-check-label" for="ff-{{ field.uuid }}-{{ forloop.counter }}">{{ opt }}</label>
                                </div>
                            {% endfor %}
                            {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- newsletter opt-out -->
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" role="switch" id="newsletter" name="newsletter">
            <label class="form-check-label" for="newsletter">{% translate "I do not want to receive the newsletter." %}</label>
        </div>

        {% if product.legal_link %}
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" role="switch" id="acknowledge" name="acknowledge"
                       required>

                <label class="form-check-label" for="acknowledge">
                    <span>{% translate "I accept the " %}</span>
                    <!-- Affichage du lien vers les CGU/CGV/Status s'il existe -->
                    {% if product.categorie_article == 'A' %}
                        <span>
                    {% if product.legal_link != None %}
                        <a class="text-info" href="{{ product.legal_link }}" target="_blank">
                        {% translate "association rules and regulations." %}
                    </a>
                    {% else %}
                        {% translate "association rules and regulations." %}
                    {% endif %}
                    </span>
                    {% else %}
                        {% if product.legal_link != None %}
                            <a class="text-info" href="{{ product.legal_link }}"
                               target="_blank">{% translate "terms and conditions." %}</a>
                        {% else %}
                            <span>{% translate "terms and conditions." %}</span>
                        {% endif %}
                    {% endif %}
                </label>
            </div>
        {% endif %}
    </div>

    <div class="p-3">
        <button id="membership-submit" type="submit" class="btn btn-primary w-100 mb-3">
            {% if product.validate_button_text %}{{ product.validate_button_text }}{% else %}
                {% translate 'Send my subscription request' %}{% endif %}
        </button>
        <a href="." class="btn btn-danger d-block test-membership-bt-cancel">{% translate 'Cancel' %}</a>
    </div>
</form>
