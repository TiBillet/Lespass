{% extends "faire_festival/base.html" %}
{% load static i18n tibitags %}

{% block title %}{% if config.event_menu_name %}{{ config.event_menu_name }}{% else %}{% translate 'Calendar' %}{% endif %}{% endblock %}

{% block main %}

<!-- =======================================================================
     PAGE LISTE DES ÉVÉNEMENTS
     Adaptée depuis la maquette events.html du Faire Festival

     STRUCTURE DE dated_events :
     C'est un dict {date: [event, event, ...]} classé par date.
     On itère d'abord sur les dates, puis sur les événements de chaque date.
     ======================================================================= -->

<section class="container-fluid py-4 conteneur-principal">
    <div class="container">

        <!-- Conteneur des boutons de filtre -->
        <div class="d-flex justify-content-center flex-wrap gap-3 conteneur-filtres mb-4">

            <!-- Bouton Admin : Ajouter un événement (si autorisé) -->
            {% if user|can_create_event_tag %}
                <button class="bouton-filtre fond-jaune texte-bleu"
                        type="button"
                        hx-get="/event/simple_add_event/"
                        hx-target="#offcanvas-event-admin"
                        hx-swap="innerHTML"
                        data-bs-toggle="offcanvas"
                        data-bs-target="#adminAddEventPanel"
                        aria-controls="adminAddEventPanel">
                    <i class="bi bi-plus-circle me-1"></i>
                    {% translate 'Ajouter un évènement' %}
                </button>
            {% endif %}

            <!-- Filtre par tag/catégorie -->
            {% if all_tags %}
                <div class="dropdown">
                    <button class="bouton-filtre dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        {% if active_tag %}
                            {{ active_tag.name }}
                        {% else %}
                            {% translate 'Filtrer par tags' %}
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu bordure-epaisse ombre-dure-petite">
                        <!-- Option "Tous" pour réinitialiser le filtre -->
                        <li>
                            <a class="dropdown-item police-mono" href="{% url 'event-list' %}">
                                {% translate 'Effacer le filtre' %}
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <!-- Liste de tous les tags disponibles -->
                        {% for tag in all_tags %}
                            <li>
                                <a class="dropdown-item police-mono"
                                   href="?tag={{ tag.slug }}">
                                    {{ tag.name }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

        </div>

        <!-- =================================================================
             GRILLE D'ÉVÉNEMENTS
             dated_events est un dict {date: [event, event, ...]}
             On itère sur chaque date, puis sur chaque événement de cette date
             ================================================================= -->
        <div class="row g-4" id="event_list">

            {% for date_key, events in dated_events.items %}
                {% for event in events %}

                    <!-- CARTE ÉVÉNEMENT -->
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="carte-evenement">
                            <div>
                                <!-- IMAGE DE L'ÉVÉNEMENT -->
                                <a href="/event/{{ event.slug }}/"
                                   hx-get="/event/{{ event.slug }}/"
                                   hx-target="body"
                                   hx-push-url="true"
                                   class="d-block text-decoration-none">
                                    <div class="image-evenement"
                                         style="background-image: url('{% if event.sticker_img %}{{ event.sticker_img.med.url }}{% else %}{{ ""|randCardImg }}{% endif %}');">
                                    </div>
                                </a>

                                <!-- TAGS DE L'ÉVÉNEMENT -->
                                <div class="mb-2">
                                    {% for tag in event.tag.all %}
                                        <span class="etiquette-categorie">{{ tag.name|lower }}</span>
                                    {% endfor %}
                                </div>

                                <!-- TITRE DE L'ÉVÉNEMENT -->
                                <a href="/event/{{ event.slug }}/"
                                   hx-get="/event/{{ event.slug }}/"
                                   hx-target="body"
                                   hx-push-url="true"
                                   class="text-decoration-none">
                                    <h3 class="titre-evenement">
                                        {{ event.name|upper|truncatewords:6 }}
                                    </h3>
                                </a>

                                <!-- DATE ET HEURE -->
                                <div class="infos-evenement d-flex justify-content-between">
                                    <span>→ {{ event.datetime|date:"l d F" }}</span>
                                    <span>→ {{ event.datetime|date:"H" }}h
                                        {% if event.end_datetime %}
                                            - {{ event.end_datetime|date:"H" }}h
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <!-- PIED DE CARTE : Boutons d'action -->
                            <div class="pied-carte">
                                <!-- Lien vers la page de détail (utilise le slug comme le skin reunion) -->
                                <a href="/event/{{ event.slug }}/"
                                   class="bouton-petit-jaune w-100 text-center"
                                   hx-get="/event/{{ event.slug }}/"
                                   hx-target="body"
                                   hx-push-url="true">
                                    {% translate 'See more' %}
                                </a>
                            </div>
                        </div>
                    </div>

                {% endfor %}
            {% empty %}

                <!-- MESSAGE SI AUCUN ÉVÉNEMENT TROUVÉ -->
                <div class="col-12">
                    <div class="bordure-epaisse p-5 text-center bg-white">
                        <h3 class="texte-bleu police-titre mb-3">
                            {% translate 'No results for this search.' %}
                        </h3>
                        <p class="texte-bleu police-mono">
                            {% translate 'No events match your search criteria. Try adjusting your filters.' %}
                        </p>
                        <a href="{% url 'event-list' %}"
                           class="btn bouton-pilule fond-bleu text-white mt-3">
                            {% translate 'Effacer le filtre' %}
                        </a>
                    </div>
                </div>

            {% endfor %}

        </div> <!-- Fin de la grille row -->

        <!-- PAGINATION : Bouton "Charger Plus" -->
        {% if paginated_info.has_next %}
            <div class="text-center py-5">
                <a href="?page={{ paginated_info.page|add:1 }}{% if tags %}&tag={{ tags.0 }}{% endif %}"
                   class="bouton-charger-plus">
                    {% translate 'Load more events' %}
                </a>
            </div>
        {% endif %}

    </div>
</section>

<!-- OFFCANVAS ADMIN : Ajout rapide d'événement -->
<div class="offcanvas-start offcanvas" tabindex="-1" id="adminAddEventPanel" aria-labelledby="adminAddEventPanelLabel">
    <div class="offcanvas-header fond-jaune bordure-bas-epaisse">
        <h5 class="offcanvas-title texte-bleu police-titre" id="adminAddEventPanelLabel">{% translate 'Ajouter un évènement' %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="{% trans 'Close' %}"></button>
    </div>
    <div class="offcanvas-body" id="offcanvas-event-admin">
        {# Le contenu du formulaire est chargé ici via HTMX #}
        <div class="text-center py-5">
            <div class="spinner-border texte-bleu" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

{% endblock %}
