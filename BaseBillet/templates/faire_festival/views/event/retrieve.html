{% extends "faire_festival/base.html" %}
{% load static i18n tibitags %}

{% block title %}{{ event.name }}{% endblock %}

{% block meta_description %}{% if event.short_description %}{{ event.short_description|striptags }}
{% elif event.long_description %}{{ event.long_description|striptags|truncatechars:150 }}{% else %}{{ event.name }}
{% endif %} - Un évènement publié sur le logiciel libre TiBillet{% endblock %}

{% block og_type %}event{% endblock %}
{% block og_title %}{{ event.name }}{% endblock %}
{% block og_description %}{% if event.short_description %}{{ event.short_description|striptags }}
{% elif event.long_description %}{{ event.long_description|striptags|truncatechars:150 }}{% else %}{{ event.name }}
{% endif %} - Un évènement publié sur le logiciel libre TiBillet{% endblock %}
{% block og_image %}{{ event.get_social_card }}{% endblock %}
{% block og_image_alt %}{{ event.name }} - {{ config.organisation }}{% endblock %}

{% block twitter_title %}{{ event.name }}{% endblock %}
{% block twitter_description %}{% if event.short_description %}{{ event.short_description|striptags }}
{% elif event.long_description %}{{ event.long_description|striptags|truncatechars:150 }}{% else %}{{ event.name }}
{% endif %} - Un évènement publié sur le logiciel libre TiBillet{% endblock %}
{% block twitter_image %}{{ event.get_social_card }}{% endblock %}
{% block twitter_image_alt %}{{ event.name }} - {{ config.organisation }}{% endblock %}

{% block extra_meta %}
    {% if event.postal_address %}
        {% if event.postal_address.latitude and event.postal_address.longitude %}
            <meta name="geo.position"
                  content="{{ event.postal_address.latitude }};{{ event.postal_address.longitude }}">
            <meta name="ICBM" content="{{ event.postal_address.latitude }}, {{ event.postal_address.longitude }}">
        {% endif %}
        <meta name="geo.placename"
              content="{{ event.postal_address.address_locality }}, {{ event.postal_address.address_country }}">
        <meta name="geo.region" content="
                {{ event.postal_address.address_country }}{% if event.postal_address.address_region %}-{{ event.postal_address.address_region }}{% endif %}">
    {% endif %}
{% endblock %}

{% block scripts %}
    <script>
        // Check if openbookingPanel parameter exists in URL and open booking panel if it does
        // Example URL: https://example.com/event/123/?openbookingPanel=true
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('openbookingPanel')) {
                const bookingPanel = document.getElementById('bookingPanel');
                if (bookingPanel) {
                    const offcanvas = new bootstrap.Offcanvas(bookingPanel);
                    offcanvas.show();
                }
            }
        });
    </script>

    <!-- Schema.org Event structured data -->
    <script type="application/ld+json">
        {
						"@context": "https://schema.org",
						"@type": "Event",
						"name": "{{ event.name }}",
        "description": "{% if event.short_description %}
        {{ event.short_description|striptags }}{% elif event.long_description %}
        {{ event.long_description|striptags|truncatechars:150 }}{% else %}{{ event.name }}{% endif %} - Un évènement publié sur le logiciel libre TiBillet",
        "image": "{% if event.img %}{{ event.img.hdr.url }}{% else %}{% static 'reunion/img/favicon.png' %}{% endif %}",
        "startDate": "{{ event.datetime|date:'c' }}",
        {% if event.end_datetime %}"endDate": "{{ event.end_datetime|date:'c' }}",{% endif %}
        "eventStatus": "https://schema.org/EventScheduled",
        {% if event.complet %}"eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",{% endif %}
        "location": {
            "@type": "Place",
            "name": "{{ config.organisation }}",
        {% if event.postal_address %}"address": {
                "@type": "PostalAddress",
            {% if event.postal_address.name %}"name": "{{ event.postal_address.name }}",{% endif %}
            "streetAddress": "{{ event.postal_address.street_address }}",
                "addressLocality": "{{ event.postal_address.address_locality }}",
                "postalCode": "{{ event.postal_address.postal_code }}",
                "addressCountry": "{{ event.postal_address.address_country }}"
            },
            {% if event.postal_address.latitude and event.postal_address.longitude %}"geo": {
                "@type": "GeoCoordinates",
                "latitude": "{{ event.postal_address.latitude }}",
                "longitude": "{{ event.postal_address.longitude }}"
            }{% endif %}{% endif %}
        },
        "organizer": {
            "@type": "Organization",
            "name": "{{ config.organisation }}",
            "url": "{{ request.build_absolute_uri|slice:':-6' }}"
        },
        {% if event.price_min %}"offers": {
            "@type": "Offer",
            "price": "{{ event.price_min }}",
            "priceCurrency": "EUR",
            "availability": "{% if event.complet %}https://schema.org/SoldOut{% else %}https://schema.org/InStock
        {% endif %}",
            "url": "{{ request.build_absolute_uri }}"
        }{% endif %}
        }
    </script>
{% endblock %}

{% block offcanvas %}
    {# Style spécifique pour l'offcanvas de réservation (look reunion) #}
    <style>
        #bookingPanel { --bs-offcanvas-width: 100vw; }
        @media (min-width: 992px) { #bookingPanel { --bs-offcanvas-width: 800px; } }
    </style>

    <!-- OFFCANVAS RÉSERVATION : Formulaire de réservation (look reunion) -->
    <div class="offcanvas-start offcanvas" tabindex="-1" id="bookingPanel" aria-labelledby="bookingPanelLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="bookingPanelLabel">{% translate 'Request booking' %}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="{% trans 'Close' %}"></button>
        </div>
        <div class="offcanvas-body">
            {% include 'reunion/views/event/partial/booking_form.html' %}
        </div>
    </div>
{% endblock %}

{% block main %}

<!-- =======================================================================
     PAGE DÉTAIL D'UN ÉVÉNEMENT
     Adaptée depuis la maquette event_detail.html du Faire Festival
     Affiche toutes les informations détaillées d'un événement
     ======================================================================= -->
<main class="container py-5 conteneur-principal">

    <!-- ===================================================================
         SECTION HERO : Présentation principale de l'événement
         Image à gauche, Informations clés à droite
         =================================================================== -->
    <div class="row align-items-center mb-5">

        <!-- ============================================================
             COLONNE IMAGE (Gauche)
             Grande image de l'événement ou placeholder jaune
             ============================================================ -->
        <div class="col-md-6 mb-4 mb-md-0">
            <!-- Image principale de l'événement -->
            <div class="image-detail-grand"
                 style="background-image: url('{% if event.img %}{{ event.img.hdr.url }}{% else %}{{ ""|randImg }}{% endif %}');">
            </div>

            <!-- Tags de l'événement (catégories/thématiques) -->
            <div class="mt-3">
                {% for tag in event.tag.all %}
                    <span class="etiquette-categorie">{{ tag.name|lower }}</span>
                {% endfor %}
            </div>
        </div>

        <!-- ============================================================
             COLONNE INFORMATIONS (Droite)
             Titre, date, heure et bouton d'inscription
             ============================================================ -->
        <div class="col-md-6 ps-md-5">

            <!-- Titre de l'événement -->
            <h1 class="titre-detail mb-4 texte-bleu">
                {{ event.name|upper }}
            </h1>

            <!-- Informations clés avec flèches -->
            <div class="infos-clefs texte-bleu mb-4">

                <!-- Date de l'événement -->
                <div class="d-flex align-items-center mb-2">
                    <span class="fleche-info me-3">→</span>
                    <span class="h4 police-mono fw-bold m-0">
                        {{ event.datetime|date:"l d F Y" }}
                    </span>
                </div>

                <!-- Heure de début et de fin -->
                <div class="d-flex align-items-center mb-3">
                    <span class="fleche-info me-3">→</span>
                    <span class="h4 police-mono fw-bold m-0">
                        {{ event.datetime|date:"H:i" }}
                        {% if event.end_datetime %}
                            - {{ event.end_datetime|date:"H:i" }}
                        {% endif %}
                    </span>
                </div>

                <!-- Lieu (optionnel) -->
                {% if event.postal_address %}
                    <div class="d-flex align-items-center mb-3">
                        <span class="fleche-info me-3">→</span>
                        <span class="h5 police-mono fw-bold m-0">
                            <i class="bi bi-geo-alt me-2"></i>
                            {{ event.postal_address.name }}
                        </span>
                    </div>
                {% endif %}

                <!-- Jauge (places disponibles) -->
                {% if event.jauge_max and event.show_gauge %}
                    <div class="d-flex align-items-center mb-3">
                        <span class="fleche-info me-3">→</span>
                        <span class="h6 police-mono m-0">
                            <i class="bi bi-people me-2"></i>
                            {% if event.complet %}
                                <span class="text-danger">{% translate "Full capacity: The event is sold out." %}</span>
                            {% elif event_max_per_user_reached %}
                                 <span class="text-danger">{% translate "You have reached the maximum number of tickets for this event." %}</span>
                            {% else %}
                                {% blocktranslate with available=event.remaining_seats total=event.jauge_max %}
                                {{ available }} / {{ total }} places available
                                {% endblocktranslate %}
                            {% endif %}
                        </span>
                    </div>
                {% endif %}

            </div>

            <!-- ============================================================
                 ZONE D'INSCRIPTION / RÉSERVATION
                 La logique suit celle du skin 'reunion' :
                 1. Si l'événement est complet -> Bouton désactivé
                 2. Si la limite par utilisateur est atteinte -> Bouton désactivé
                 3. Si des produits existent -> Bouton d'ouverture du panel de réservation
                 4. Si aucun produit -> Pas de bouton (conformément à la demande)
                 ============================================================ -->
            {% if event.complet %}
                <button class="bouton-inscription fw-bold" disabled>
                    {% translate "Full capacity: The event is sold out." %}
                </button>
            {% elif event_max_per_user_reached %}
                <button class="bouton-inscription fw-bold" disabled>
                    {% translate "You have reached the maximum number of tickets for this event." %}
                </button>
            {% elif event.products.exists %}
                <!-- Cas 3 : Des produits de billetterie existent, on affiche le bouton de réservation -->
                <button class="bouton-inscription fw-bold"
                        data-bs-toggle="offcanvas"
                        data-bs-target="#bookingPanel"
                        aria-controls="bookingPanel"
                        data-testid="booking-open-panel">
                    {% if event.reservation_button_name %}{{ event.reservation_button_name }}{% else %}{% translate "I want to book one or more seats" %}{% endif %}
                </button>
            {% endif %}
            <!-- Cas 4 : Aucun produit présent -> On n'affiche rien du tout ici -->

            <!-- Zone de résultat pour la réservation (HTMX) -->
            <div id="reservation-result" class="mt-3"></div>

        </div> <!-- Fin colonne informations -->

    </div> <!-- Fin row hero -->

    <!-- ===================================================================
         SECTION DESCRIPTION DÉTAILLÉE
         Boite avec bordure contenant la description complète de l'événement
         =================================================================== -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="boite-description bordure-epaisse">
                {% if event.short_description or event.long_description %}
                    <div class="texte-description texte-bleu police-mono">
                        <!-- Description courte (si disponible) -->
                        {% if event.short_description %}
                            <p class="fw-bold">{{ event.short_description }}</p>
                        {% endif %}

                        <!-- Description longue (si disponible) -->
                        {% if event.long_description %}
                            {{ event.long_description|safe }}
                        {% endif %}
                    </div>
                {% else %}
                    <!-- Message par défaut si pas de description -->
                    <p class="texte-description texte-bleu police-mono">
                        {% translate 'No detailed description available for this event.' %}
                    </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ===================================================================
         SECTION INFORMATIONS SUPPLÉMENTAIRES
         Intervenants, lieu, organisateurs, etc.
         =================================================================== -->
    <div class="row mb-5">
        <div class="col-12 texte-bleu police-mono">

            <!-- Intervenants (si disponible) -->
            {% comment %}
            <!-- À implémenter si le modèle Event possède un champ intervenants -->
            {% if event.intervenants %}
                <div class="mb-3">
                    <p class="fw-bold mb-2">{% translate 'Speakers:' %}</p>
                    <p>{{ event.intervenants }}</p>
                </div>
            {% endif %}
            {% endcomment %}

            <!-- Lieu détaillé -->
            {% if event.postal_address %}
                <div class="mb-3">
                    <p class="fw-bold mb-2">{% translate 'Location:' %}</p>
                    <p>{{ event.postal_address }}</p>
                </div>
            {% endif %}

            <!-- Lien externe (si disponible) -->
            {% if event.external_link %}
                <div class="mb-3">
                    <p class="fw-bold mb-2">{% translate 'More information:' %}</p>
                    <a href="{{ event.external_link }}"
                       target="_blank"
                       class="bouton-petit-bleu">
                        {% translate 'External link' %}
                        <i class="bi bi-box-arrow-up-right ms-1"></i>
                    </a>
                </div>
            {% endif %}

        </div>
    </div>

    <!-- ===================================================================
         SECTION JAUGE ET VOLONTAIRES
         Affiche le taux de remplissage et les besoins en bénévolat
         =================================================================== -->
    <div class="row mb-4">
        <div class="col-12 text-center texte-bleu police-mono">
            <!-- Jauge de remplissage (si activée) -->
            {% if event.show_gauge %}
                <div class="mb-2">
                    <i class="bi bi-people me-2"></i>
                    {{ event.valid_tickets_count }} {% translate "reservations validées sur" %} {{ event.jauge_max }} {% translate "places disponibles" %}
                </div>
            {% endif %}

            <!-- Bénévolat / Actions (si existantes) -->
            {% if action_total_jauge %}
                <div class="mb-2">
                    <i class="bi bi-hand-thumbs-up me-2"></i>
                    {% translate "Looking for volunteers" %}&nbsp;:
                    <span> ({{ inscrits }}/{{ action_total_jauge }} {% translate "open slots" %})</span>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- ===================================================================
         SECTION PRODUITS ASSOCIÉS (Billetterie)
         Affiche les différents tarifs/produits disponibles pour cet événement
         =================================================================== -->
    {% if event.products.exists %}
        <div class="row mb-5">
            <div class="col-12">
                <div class="bordure-epaisse bg-white p-4">
                    <h3 class="texte-bleu police-titre mb-4">
                        {% translate 'Tickets and prices' %}
                    </h3>

                    <div class="row g-3">
                        {% for product in event.products.all %}
                            <div class="col-md-6">
                                <div class="carte-evenement">
                                    <div>
                                        <h4 class="titre-evenement h5">
                                            {{ product.name }}
                                        </h4>

                                        {% if product.short_description %}
                                            <p class="small texte-bleu police-mono">
                                                {{ product.short_description }}
                                            </p>
                                        {% endif %}

                                        <!-- Prix -->
                                        <div class="infos-evenement">
                                            {% if product.prices.exists %}
                                                {% for price in product.prices.all %}
                                                    <span class="fw-bold">
                                                        {{ price.prix }} €
                                                        {% if price.name %}
                                                            ({{ price.name }})
                                                        {% endif %}
                                                    </span>
                                                {% endfor %}
                                            {% else %}
                                                <span class="fw-bold">{% translate 'Free' %}</span>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="pied-carte mt-3">
                                        <button class="bouton-petit-bleu w-100"
                                                data-bs-toggle="offcanvas"
                                                data-bs-target="#bookingPanel"
                                                aria-controls="bookingPanel"
                                                data-testid="booking-open-panel">
                                            {% translate 'Select' %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- ===================================================================
         SECTION ÉVÉNEMENTS SIMILAIRES (Optionnel)
         Propose d'autres événements de la même catégorie
         =================================================================== -->
    {% comment %}
    <!-- À implémenter si besoin -->
    <div class="row">
        <div class="col-12">
            <h3 class="texte-bleu police-titre mb-4 text-center">
                {% translate 'Similar events' %}
            </h3>
            <!-- Grille d'événements similaires -->
        </div>
    </div>
    {% endcomment %}

    <!-- Bouton retour à la liste -->
    <div class="row mt-5">
        <div class="col-12 text-center">
            <a href="{% url 'event-list' %}"
               class="btn bouton-pilule fond-bleu text-white"
               hx-get="{% url 'event-list' %}"
               hx-target="body"
               hx-push-url="true">
                <i class="bi bi-arrow-left me-2"></i>
                {% translate 'Back to events list' %}
            </a>
        </div>
    </div>

</main>

{% endblock %}
